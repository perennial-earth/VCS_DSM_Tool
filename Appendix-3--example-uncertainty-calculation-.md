Appendix 3: Example uncertainty calculation
================

This document demonstrates how to calculate the variance of the mean SOC
stock and stock changes following the methods outlined in [Wadoux and
Heuvelink (2023)](https://doi.org/10.1111/2041-210X.14106) and described
in the VCS Tool for Quantifying Organic Carbon Stocks Using Digital Soil
Mapping: Calibration, Validation and Uncertainty Estimation.

- The example here is based on a simulation of 100 spatially clustered
  fields, illustrated below, covering a total of 20,560 acres. Each
  field in this simulation is one of four sizes: 80, 160, 240, or 320
  acres. The fields are within an area of approximately 200 by 200
  kilometers.

- The methods developed here are general, and can be applied to regions
  of any size in any spatial configuration, including small holder
  farms.

- The example is illustrated using the [R Project for Statistical
  Computing](http://r-project.org). Code is indicated using
  `Courier font`. The worked example requires the `gstat`, `sf` `terra`
  and `viridis` packages.

Throughout the document, code is presented in blocks that can be shown
or hidden using a button in the top-right corner of each block. By
default, all code blocks are hidden. You can toggle the visibility of
individual blocks by clicking the “Show” or “Hide” button. Additionally,
at the top of the document, a “Code” drop down allows you to toggle the
visibility of all code blocks at once.

Each executable code block is followed by a line-by-line explanation of
how the code is structured, with references to specific sections in the
main text of the tool. The calculations presented in this document can
be run individually or by running the “End-to-end code block” that
immediately follows this paragraph, which contains all the necessary
code in a single location. Running the End-to-end code will reproduce
all the calculations and graphics in the document.

<details>
  <summary>Show Code</summary>

``` r
#End-to-end code block

# Major section I

set.seed(1)
install.packages(c("gstat", "sf","terra","viridis"))
library(gstat)
library(sf)
library(terra)
library(viridis)

# Major section II

set.seed(1)
simulate_soc <- function(polygon, ground_sample_distance=10,
                         psill=0.1, range=200, nugget=0, beta=54, model='Sph', scale=4){

   # step 1

   polygon <- st_transform(polygon, 5070)

   # step 2

   field <- st_make_grid(polygon, cellsize = ground_sample_distance, what = "centers")
   field_coords <- st_coordinates(field)
   field <- as.data.frame(field_coords)
   names(field) <- c('x1', 'x2')

   # step 3

   soc_stock <- gstat(formula=z~1, locations=~x1+x2, dummy=TRUE, beta=beta,
                 model=vgm(psill=psill, range=range, nugget=nugget, model=model), nmax=40)
   soc_stock <- predict(soc_stock, newdata=field, nsim=1)

   # step 4

   combined_matrix <- cbind(field$x1, field$x2, soc_stock$sim1)
   soc_stock_points_df <- data.frame(x = combined_matrix[, 1], y = combined_matrix[, 2],
                                     soc_stock = combined_matrix[, 3])
   soc_stock_points <- vect(soc_stock_points_df, geom = c("x", "y"), crs = "EPSG:5070")
   raster_template <- rast(ext(soc_stock_points), res = ground_sample_distance, crs = "EPSG:5070")
   soc_stock <- rasterize(soc_stock_points, raster_template, field = "soc_stock")

   # step 5

   sigma <- gstat(formula=z~1, locations=~x1+x2, dummy=TRUE, beta=0,
        model=vgm(psill=1, range=range, nugget=0, model=model), nmax=40)
   sigma_pred <- predict(sigma, newdata=field, nsim=1)
   sigma <- qchisq(pnorm(sigma_pred$sim1), 2)
   sigma <- sqrt(sigma) * scale

   # step 6

   combined_matrix <- cbind(field$x1, field$x2, sigma)
   sigma_points_df <- data.frame(x = combined_matrix[, 1], y = combined_matrix[, 2],
                                 sigma = combined_matrix[, 3])
   sigma_points <- vect(sigma_points_df, geom = c("x", "y"), crs = "EPSG:5070")
   raster_template <- rast(ext(sigma_points), res = ground_sample_distance, crs = "EPSG:5070")
   sigma <- rasterize(sigma_points, raster_template, field = "sigma")

   # step 7

   error <- gstat(formula=z~1, locations=~x1+x2, dummy=TRUE, beta=0,
        model=vgm(psill=1, range=range, nugget=0, model=model), nmax=40)
   error_pred <- predict(error, newdata=field, nsim=1)
   error <- (error_pred$sim1 - mean(error_pred$sim1))/sd(error_pred$sim1)

   # step 8

   combined_matrix <- cbind(field$x1, field$x2, error)
   error_points_df <- data.frame(x = combined_matrix[, 1], y = combined_matrix[, 2],
                                 error = combined_matrix[, 3])
   error_points <- vect(error_points_df, geom = c("x", "y"), crs = "EPSG:5070")
   raster_template <- rast(ext(error_points), res = ground_sample_distance, crs = "EPSG:5070")
   error <- rasterize(error_points, raster_template, field = "error")

   # step 9

   soc_stock_error <- error*sigma
   soc_stock_hat <- soc_stock + soc_stock_error

   # step 10

   return(list(soc_stock=soc_stock, soc_stock_hat=soc_stock_hat,
               soc_stock_error=soc_stock_error, sigma=sigma))

}

# Major section III

set.seed(1)

# step 1

fields_string <- '{
"type": "FeatureCollection",
"name": "simulated_fields",
"crs": { "type": "name", "properties": { "name": "urn:ogc:def:crs:EPSG::5070" } },
"features": [
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 145157.901969870261382, 135341.593432327586925 ], [ 145157.901969870261382, 136479.571991000819253 ], [ 146295.88052854349371, 136479.571991000819253 ], [ 146295.88052854349371, 135341.593432327586925 ], [ 145157.901969870261382, 135341.593432327586925 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 143280.429234553274, 129700.909625173051609 ], [ 143280.429234553274, 130686.427965946058976 ], [ 144265.947575326281367, 130686.427965946058976 ], [ 144265.947575326281367, 129700.909625173051609 ], [ 143280.429234553274, 129700.909625173051609 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 136114.261258934770012, 142700.958537676313426 ], [ 136114.261258934770012, 143686.476878449320793 ], [ 137099.779599707777379, 143686.476878449320793 ], [ 137099.779599707777379, 142700.958537676313426 ], [ 136114.261258934770012, 142700.958537676313426 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 165308.245266636513406, 137339.885777786897961 ], [ 165308.245266636513406, 138477.864336460130289 ], [ 166446.223825309745735, 138477.864336460130289 ], [ 166446.223825309745735, 137339.885777786897961 ], [ 165308.245266636513406, 137339.885777786897961 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 122639.673937464278424, 128160.288199407310458 ], [ 122639.673937464278424, 129298.266758080542786 ], [ 123777.652496137510752, 129298.266758080542786 ], [ 123777.652496137510752, 128160.288199407310458 ], [ 122639.673937464278424, 128160.288199407310458 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 138974.744563743850449, 109786.563249276121496 ], [ 138974.744563743850449, 110772.081590049128863 ], [ 139960.262904516857816, 110772.081590049128863 ], [ 139960.262904516857816, 109786.563249276121496 ], [ 138974.744563743850449, 109786.563249276121496 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 160303.090820463432465, 123133.384369816878461 ], [ 160303.090820463432465, 123702.373649153494625 ], [ 160872.080099800019525, 123702.373649153494625 ], [ 160872.080099800019525, 123133.384369816878461 ], [ 160303.090820463432465, 123133.384369816878461 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 146049.925255510985153, 114757.434049850256997 ], [ 146049.925255510985153, 115562.10640553299163 ], [ 146854.597611193690682, 115562.10640553299163 ], [ 146854.597611193690682, 114757.434049850256997 ], [ 146049.925255510985153, 114757.434049850256997 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 144173.199657852732344, 94671.736420751229161 ], [ 144173.199657852732344, 95809.71497942446149 ], [ 145311.178216525964672, 95809.71497942446149 ], [ 145311.178216525964672, 94671.736420751229161 ], [ 144173.199657852732344, 94671.736420751229161 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 151374.378671368351206, 122664.884349430110888 ], [ 151374.378671368351206, 123650.402690203118254 ], [ 152359.897012141358573, 123650.402690203118254 ], [ 152359.897012141358573, 122664.884349430110888 ], [ 151374.378671368351206, 122664.884349430110888 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 125943.262877311150078, 125930.587300641971524 ], [ 125943.262877311150078, 126916.105641414978891 ], [ 126928.781218084157445, 126916.105641414978891 ], [ 126928.781218084157445, 125930.587300641971524 ], [ 125943.262877311150078, 125930.587300641971524 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 153130.545107728394214, 115159.737985610452597 ], [ 153130.545107728394214, 115964.41034129318723 ], [ 153935.217463411099743, 115964.41034129318723 ], [ 153935.217463411099743, 115159.737985610452597 ], [ 153130.545107728394214, 115159.737985610452597 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 152530.084722661820706, 146546.064735146152088 ], [ 152530.084722661820706, 147531.583075919159455 ], [ 153515.603063434828073, 147531.583075919159455 ], [ 153515.603063434828073, 146546.064735146152088 ], [ 152530.084722661820706, 146546.064735146152088 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 145905.121982681215741, 132762.82098411876359 ], [ 145905.121982681215741, 133567.493339801498223 ], [ 146709.79433836392127, 133567.493339801498223 ], [ 146709.79433836392127, 132762.82098411876359 ], [ 145905.121982681215741, 132762.82098411876359 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 112651.577805660956074, 122421.528239680061233 ], [ 112651.577805660956074, 123559.506798353293561 ], [ 113789.556364334188402, 123559.506798353293561 ], [ 113789.556364334188402, 122421.528239680061233 ], [ 112651.577805660956074, 122421.528239680061233 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 101369.272834764575236, 138570.954285429848824 ], [ 101369.272834764575236, 139375.626641112583457 ], [ 102173.945190447309869, 139375.626641112583457 ], [ 102173.945190447309869, 138570.954285429848824 ], [ 101369.272834764575236, 138570.954285429848824 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 115408.022759273779229, 151359.765026564273285 ], [ 115408.022759273779229, 152497.743585237505613 ], [ 116546.001317947011557, 152497.743585237505613 ], [ 116546.001317947011557, 151359.765026564273285 ], [ 115408.022759273779229, 151359.765026564273285 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 147961.892260234744754, 151526.177970361080952 ], [ 147961.892260234744754, 152330.850326043815585 ], [ 148766.564615917450283, 152330.850326043815585 ], [ 148766.564615917450283, 151526.177970361080952 ], [ 147961.892260234744754, 151526.177970361080952 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 130505.756363293243339, 153601.480326096876524 ], [ 130505.756363293243339, 154586.998666869883891 ], [ 131491.274704066250706, 154586.998666869883891 ], [ 131491.274704066250706, 153601.480326096876524 ], [ 130505.756363293243339, 153601.480326096876524 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 135630.5870061814785, 132578.617851524351863 ], [ 135630.5870061814785, 133383.290207207086496 ], [ 136435.259361864213133, 133383.290207207086496 ], [ 136435.259361864213133, 132578.617851524351863 ], [ 135630.5870061814785, 132578.617851524351863 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 72334.376593913824763, 25798.734105261602963 ], [ 72334.376593913824763, 26603.406460944333958 ], [ 73139.048949596559396, 26603.406460944333958 ], [ 73139.048949596559396, 25798.734105261602963 ], [ 72334.376593913824763, 25798.734105261602963 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 55496.932607235517935, 23994.285919064826885 ], [ 55496.932607235517935, 24563.275198401439411 ], [ 56065.921886572134099, 24563.275198401439411 ], [ 56065.921886572134099, 23994.285919064826885 ], [ 55496.932607235517935, 23994.285919064826885 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 58697.939336054994783, 19145.749188500325545 ], [ 58697.939336054994783, 19950.421544183060178 ], [ 59502.611691737729416, 19950.421544183060178 ], [ 59502.611691737729416, 19145.749188500325545 ], [ 58697.939336054994783, 19145.749188500325545 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 75704.292960263803252, 11636.488241425633532 ], [ 75704.292960263803252, 12774.466800098862223 ], [ 76842.27151893703558, 12774.466800098862223 ], [ 76842.27151893703558, 11636.488241425633532 ], [ 75704.292960263803252, 11636.488241425633532 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 66918.974593142032973, 42980.79477037252218 ], [ 66918.974593142032973, 43549.784049709138344 ], [ 67487.963872478649137, 43549.784049709138344 ], [ 67487.963872478649137, 42980.79477037252218 ], [ 66918.974593142032973, 42980.79477037252218 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 56685.876494248906965, 0.0 ], [ 56685.876494248906965, 804.672355682734633 ], [ 57490.548849931641598, 804.672355682734633 ], [ 57490.548849931641598, 0.0 ], [ 56685.876494248906965, 0.0 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 75692.009489521762589, 42305.751386167990859 ], [ 75692.009489521762589, 43291.269726941012777 ], [ 76677.527830294784508, 43291.269726941012777 ], [ 76677.527830294784508, 42305.751386167990859 ], [ 75692.009489521762589, 42305.751386167990859 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 49630.625905063578102, 8782.640547267079455 ], [ 49630.625905063578102, 9768.158888040097736 ], [ 50616.144245836600021, 9768.158888040097736 ], [ 50616.144245836600021, 8782.640547267079455 ], [ 49630.625905063578102, 8782.640547267079455 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 43478.568443753028987, 38460.82331394252833 ], [ 43478.568443753028987, 39446.341654715550249 ], [ 44464.08678452604363, 39446.341654715550249 ], [ 44464.08678452604363, 38460.82331394252833 ], [ 43478.568443753028987, 38460.82331394252833 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 61227.033085654264141, 5155.381889572036016 ], [ 61227.033085654264141, 5960.054245254770649 ], [ 62031.705441336998774, 5960.054245254770649 ], [ 62031.705441336998774, 5155.381889572036016 ], [ 61227.033085654264141, 5155.381889572036016 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 103037.727414619075716, 132270.954432818543864 ], [ 103037.727414619075716, 133408.932991491776193 ], [ 104175.705973292308045, 133408.932991491776193 ], [ 104175.705973292308045, 132270.954432818543864 ], [ 103037.727414619075716, 132270.954432818543864 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 83300.700715937768109, 164710.955192765512038 ], [ 83300.700715937768109, 165848.933751438744366 ], [ 84438.679274611000437, 165848.933751438744366 ], [ 84438.679274611000437, 164710.955192765512038 ], [ 83300.700715937768109, 164710.955192765512038 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 108364.484243563463679, 137623.993931042641634 ], [ 108364.484243563463679, 138192.983210379257798 ], [ 108933.473522900079843, 138192.983210379257798 ], [ 108933.473522900079843, 137623.993931042641634 ], [ 108364.484243563463679, 137623.993931042641634 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 83124.578136528391042, 137432.406574811320752 ], [ 83124.578136528391042, 138237.078930494055385 ], [ 83929.250492211125675, 138237.078930494055385 ], [ 83929.250492211125675, 137432.406574811320752 ], [ 83124.578136528391042, 137432.406574811320752 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 110102.326110944210086, 138786.790056168189039 ], [ 110102.326110944210086, 139772.308396941196406 ], [ 111087.844451717217453, 139772.308396941196406 ], [ 111087.844451717217453, 138786.790056168189039 ], [ 110102.326110944210086, 138786.790056168189039 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 99110.777529425176908, 126392.061629651259864 ], [ 99110.777529425176908, 127377.579970424267231 ], [ 100096.295870198184275, 127377.579970424267231 ], [ 100096.295870198184275, 126392.061629651259864 ], [ 99110.777529425176908, 126392.061629651259864 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 91021.006321180757368, 135420.9474931077566 ], [ 91021.006321180757368, 136406.465833880763967 ], [ 92006.524661953764735, 136406.465833880763967 ], [ 92006.524661953764735, 135420.9474931077566 ], [ 91021.006321180757368, 135420.9474931077566 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 86501.122839395698975, 137849.900093489937717 ], [ 86501.122839395698975, 138418.889372826553881 ], [ 87070.112118732315139, 138418.889372826553881 ], [ 87070.112118732315139, 137849.900093489937717 ], [ 86501.122839395698975, 137849.900093489937717 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 72874.773602248795214, 154122.805013602192048 ], [ 72874.773602248795214, 155108.323354375199415 ], [ 73860.291943021817133, 155108.323354375199415 ], [ 73860.291943021817133, 154122.805013602192048 ], [ 72874.773602248795214, 154122.805013602192048 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 92929.144773854626692, 157655.187275788950501 ], [ 92929.144773854626692, 158459.85963147165603 ], [ 93733.817129537361325, 158459.85963147165603 ], [ 93733.817129537361325, 157655.187275788950501 ], [ 92929.144773854626692, 157655.187275788950501 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 191561.082853839790914, 61712.230497823431506 ], [ 191561.082853839790914, 62516.902853506166139 ], [ 192365.755209522496443, 62516.902853506166139 ], [ 192365.755209522496443, 61712.230497823431506 ], [ 191561.082853839790914, 61712.230497823431506 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 129031.886759883258492, 50225.331500685264473 ], [ 129031.886759883258492, 50794.320780021880637 ], [ 129600.876039219874656, 50794.320780021880637 ], [ 129600.876039219874656, 50225.331500685264473 ], [ 129031.886759883258492, 50225.331500685264473 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 166929.07864343962865, 71866.166497358732158 ], [ 166929.07864343962865, 72435.155776695348322 ], [ 167498.06792277621571, 72435.155776695348322 ], [ 167498.06792277621571, 71866.166497358732158 ], [ 166929.07864343962865, 71866.166497358732158 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 155186.747134067030856, 64005.390923383689369 ], [ 155186.747134067030856, 64810.063279066424002 ], [ 155991.419489749736385, 64810.063279066424002 ], [ 155991.419489749736385, 64005.390923383689369 ], [ 155186.747134067030856, 64005.390923383689369 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 157535.602369393891422, 67288.982522465026705 ], [ 157535.602369393891422, 67857.971801801642869 ], [ 158104.591648730478482, 67857.971801801642869 ], [ 158104.591648730478482, 67288.982522465026705 ], [ 157535.602369393891422, 67288.982522465026705 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 162547.188538991496898, 55252.177572510569007 ], [ 162547.188538991496898, 55821.166851847185171 ], [ 163116.177818328083958, 55821.166851847185171 ], [ 163116.177818328083958, 55252.177572510569007 ], [ 162547.188538991496898, 55252.177572510569007 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 177555.130808853165945, 51675.045627295075974 ], [ 177555.130808853165945, 52813.024185968308302 ], [ 178693.109367526398273, 52813.024185968308302 ], [ 178693.109367526398273, 51675.045627295075974 ], [ 177555.130808853165945, 51675.045627295075974 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 174783.703782119526295, 46807.620095306934672 ], [ 174783.703782119526295, 47945.598653980167001 ], [ 175921.682340792758623, 47945.598653980167001 ], [ 175921.682340792758623, 46807.620095306934672 ], [ 174783.703782119526295, 46807.620095306934672 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 149411.29390274384059, 61666.769351347058546 ], [ 149411.29390274384059, 62652.287692120080465 ], [ 150396.812243516847957, 62652.287692120080465 ], [ 150396.812243516847957, 61666.769351347058546 ], [ 149411.29390274384059, 61666.769351347058546 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 160879.647807697969256, 30883.627532089587476 ], [ 160879.647807697969256, 31452.61681142620364 ], [ 161448.637087034556316, 31452.61681142620364 ], [ 161448.637087034556316, 30883.627532089587476 ], [ 160879.647807697969256, 30883.627532089587476 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 173751.123617220815504, 103758.860245651521836 ], [ 173751.123617220815504, 104563.532601334256469 ], [ 174555.795972903521033, 104563.532601334256469 ], [ 174555.795972903521033, 103758.860245651521836 ], [ 173751.123617220815504, 103758.860245651521836 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 186894.469247967615956, 96608.329439950248343 ], [ 186894.469247967615956, 97413.001795632982976 ], [ 187699.141603650321485, 97413.001795632982976 ], [ 187699.141603650321485, 96608.329439950248343 ], [ 186894.469247967615956, 96608.329439950248343 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 146909.931992284284206, 108331.621853278382332 ], [ 146909.931992284284206, 108900.611132614998496 ], [ 147478.921271620871266, 108900.611132614998496 ], [ 147478.921271620871266, 108331.621853278382332 ], [ 146909.931992284284206, 108331.621853278382332 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 137704.347153485083254, 116690.441643075275351 ], [ 137704.347153485083254, 117675.959983848282718 ], [ 138689.865494258090621, 117675.959983848282718 ], [ 138689.865494258090621, 116690.441643075275351 ], [ 137704.347153485083254, 116690.441643075275351 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 152273.413796942360932, 104739.019658227960463 ], [ 152273.413796942360932, 105308.008937564576627 ], [ 152842.403076278947992, 105308.008937564576627 ], [ 152842.403076278947992, 104739.019658227960463 ], [ 152273.413796942360932, 104739.019658227960463 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 146921.215120827720966, 97771.76352481234062 ], [ 146921.215120827720966, 98909.742083485572948 ], [ 148059.193679500953294, 98909.742083485572948 ], [ 148059.193679500953294, 97771.76352481234062 ], [ 146921.215120827720966, 97771.76352481234062 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 139064.927321239490993, 102729.723082216922194 ], [ 139064.927321239490993, 103534.395437899656827 ], [ 139869.599676922225626, 103534.395437899656827 ], [ 139869.599676922225626, 102729.723082216922194 ], [ 139064.927321239490993, 102729.723082216922194 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 189628.143729580711806, 65444.061898701300379 ], [ 189628.143729580711806, 66582.040457374532707 ], [ 190766.122288253944134, 66582.040457374532707 ], [ 190766.122288253944134, 65444.061898701300379 ], [ 189628.143729580711806, 65444.061898701300379 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 159688.426189050165704, 82061.095510575862136 ], [ 159688.426189050165704, 83199.074069249094464 ], [ 160826.404747723398032, 83199.074069249094464 ], [ 160826.404747723398032, 82061.095510575862136 ], [ 159688.426189050165704, 82061.095510575862136 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 155425.535415117745288, 77509.238563938808511 ], [ 155425.535415117745288, 78313.910919621543144 ], [ 156230.207770800450817, 78313.910919621543144 ], [ 156230.207770800450817, 77509.238563938808511 ], [ 155425.535415117745288, 77509.238563938808511 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 11065.490896847884869, 68073.241000041991356 ], [ 11065.490896847884869, 69211.219558715223684 ], [ 12203.469455521113559, 69211.219558715223684 ], [ 12203.469455521113559, 68073.241000041991356 ], [ 11065.490896847884869, 68073.241000041991356 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 45368.132940816729388, 67796.706845553184394 ], [ 45368.132940816729388, 68365.696124889800558 ], [ 45937.122220153345552, 68365.696124889800558 ], [ 45937.122220153345552, 67796.706845553184394 ], [ 45368.132940816729388, 67796.706845553184394 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 5173.25926182582225, 77305.565945607260801 ], [ 5173.25926182582225, 78110.238301289995434 ], [ 5977.931617508556883, 78110.238301289995434 ], [ 5977.931617508556883, 77305.565945607260801 ], [ 5173.25926182582225, 77305.565945607260801 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 52735.326532146667887, 93933.223466890238342 ], [ 52735.326532146667887, 94737.895822572972975 ], [ 53539.99888782940252, 94737.895822572972975 ], [ 53539.99888782940252, 93933.223466890238342 ], [ 52735.326532146667887, 93933.223466890238342 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 5189.143444343777446, 69374.780498642037855 ], [ 5189.143444343777446, 69943.76977797865402 ], [ 5758.13272368039361, 69943.76977797865402 ], [ 5758.13272368039361, 69374.780498642037855 ], [ 5189.143444343777446, 69374.780498642037855 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 18897.289617016245757, 74192.413664833380608 ], [ 18897.289617016245757, 74997.086020516115241 ], [ 19701.961972698980389, 74997.086020516115241 ], [ 19701.961972698980389, 74192.413664833380608 ], [ 18897.289617016245757, 74192.413664833380608 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 17545.653036780138791, 76021.179631100589177 ], [ 17545.653036780138791, 77159.158189773821505 ], [ 18683.631595453367481, 77159.158189773821505 ], [ 18683.631595453367481, 76021.179631100589177 ], [ 17545.653036780138791, 76021.179631100589177 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 31961.9073392897335, 101491.756107603228884 ], [ 31961.9073392897335, 102629.734666276461212 ], [ 33099.885897962965828, 102629.734666276461212 ], [ 33099.885897962965828, 101491.756107603228884 ], [ 31961.9073392897335, 101491.756107603228884 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 11429.487762641874724, 65919.764679910003906 ], [ 11429.487762641874724, 66488.75395924662007 ], [ 11998.47704197848725, 66488.75395924662007 ], [ 11998.47704197848725, 65919.764679910003906 ], [ 11429.487762641874724, 65919.764679910003906 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 41435.134829127491685, 67033.62039505658322 ], [ 41435.134829127491685, 68171.598953729815548 ], [ 42573.113387800724013, 68171.598953729815548 ], [ 42573.113387800724013, 67033.62039505658322 ], [ 41435.134829127491685, 67033.62039505658322 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 40849.280293897558295, 56663.686298754182644 ], [ 40849.280293897558295, 57232.675578090798808 ], [ 41418.269573234174459, 57232.675578090798808 ], [ 41418.269573234174459, 56663.686298754182644 ], [ 40849.280293897558295, 56663.686298754182644 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 11585.553013606167951, 45781.705983143867343 ], [ 11585.553013606167951, 46919.684541817099671 ], [ 12723.531572279396642, 46919.684541817099671 ], [ 12723.531572279396642, 45781.705983143867343 ], [ 11585.553013606167951, 45781.705983143867343 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 37001.596997050000937, 61027.545959364317241 ], [ 37001.596997050000937, 61596.535238700933405 ], [ 37570.586276386617101, 61596.535238700933405 ], [ 37570.586276386617101, 61027.545959364317241 ], [ 37001.596997050000937, 61027.545959364317241 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 0.0, 45834.396962507962598 ], [ 0.0, 46972.375521181194927 ], [ 1137.97855867322869, 46972.375521181194927 ], [ 1137.97855867322869, 45834.396962507962598 ], [ 0.0, 45834.396962507962598 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 41766.609906603269337, 55364.271951205097139 ], [ 41766.609906603269337, 56502.250509878329467 ], [ 42904.588465276501665, 56502.250509878329467 ], [ 42904.588465276501665, 55364.271951205097139 ], [ 41766.609906603269337, 55364.271951205097139 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 31451.802940959765692, 13927.568613745237599 ], [ 31451.802940959765692, 15065.547172418466289 ], [ 32589.78149963299802, 15065.547172418466289 ], [ 32589.78149963299802, 13927.568613745237599 ], [ 31451.802940959765692, 13927.568613745237599 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 19216.231326370194438, 35756.761329508051858 ], [ 19216.231326370194438, 36325.750608844668022 ], [ 19785.220605706810602, 36325.750608844668022 ], [ 19785.220605706810602, 35756.761329508051858 ], [ 19216.231326370194438, 35756.761329508051858 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 22259.665690789552173, 51819.968889388299431 ], [ 22259.665690789552173, 52957.947448061531759 ], [ 23397.644249462780863, 52957.947448061531759 ], [ 23397.644249462780863, 51819.968889388299431 ], [ 22259.665690789552173, 51819.968889388299431 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 28976.861486724534188, 64382.091964086081134 ], [ 28976.861486724534188, 64951.081243422697298 ], [ 29545.850766061150352, 64951.081243422697298 ], [ 29545.850766061150352, 64382.091964086081134 ], [ 28976.861486724534188, 64382.091964086081134 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 47724.165795299435558, 45699.21466350431001 ], [ 47724.165795299435558, 46837.193222177542339 ], [ 48862.144353972667886, 46837.193222177542339 ], [ 48862.144353972667886, 45699.21466350431001 ], [ 47724.165795299435558, 45699.21466350431001 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 70172.867416825640248, 69818.866980314283865 ], [ 70172.867416825640248, 70956.845538987516193 ], [ 71310.845975498872576, 70956.845538987516193 ], [ 71310.845975498872576, 69818.866980314283865 ], [ 70172.867416825640248, 69818.866980314283865 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 70850.625328338181134, 74517.32520902986289 ], [ 70850.625328338181134, 75321.997564712597523 ], [ 71655.297684020915767, 75321.997564712597523 ], [ 71655.297684020915767, 74517.32520902986289 ], [ 70850.625328338181134, 74517.32520902986289 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 72094.099046544113662, 70439.681612130996655 ], [ 72094.099046544113662, 71008.670891467612819 ], [ 72663.088325880729826, 71008.670891467612819 ], [ 72663.088325880729826, 70439.681612130996655 ], [ 72094.099046544113662, 70439.681612130996655 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 54668.142153146640339, 94306.365042221907061 ], [ 54668.142153146640339, 95291.883382994914427 ], [ 55653.660493919662258, 95291.883382994914427 ], [ 55653.660493919662258, 94306.365042221907061 ], [ 54668.142153146640339, 94306.365042221907061 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 44694.696510508969368, 84679.106935501346015 ], [ 44694.696510508969368, 85483.779291184080648 ], [ 45499.368866191704001, 85483.779291184080648 ], [ 45499.368866191704001, 84679.106935501346015 ], [ 44694.696510508969368, 84679.106935501346015 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 42341.026263565028785, 88292.805201349474373 ], [ 42341.026263565028785, 89278.323542122496292 ], [ 43326.544604338043428, 89278.323542122496292 ], [ 43326.544604338043428, 88292.805201349474373 ], [ 42341.026263565028785, 88292.805201349474373 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 40779.882433717226377, 89132.226852284744382 ], [ 40779.882433717226377, 90270.20541095797671 ], [ 41917.860992390458705, 90270.20541095797671 ], [ 41917.860992390458705, 89132.226852284744382 ], [ 40779.882433717226377, 89132.226852284744382 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 68756.593753907320206, 72311.554305654106429 ], [ 68756.593753907320206, 73297.072646427128348 ], [ 69742.112094680342125, 73297.072646427128348 ], [ 69742.112094680342125, 72311.554305654106429 ], [ 68756.593753907320206, 72311.554305654106429 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 83243.979235271443031, 71490.332678278791718 ], [ 83243.979235271443031, 72475.851019051813637 ], [ 84229.497576044450398, 72475.851019051813637 ], [ 84229.497576044450398, 71490.332678278791718 ], [ 83243.979235271443031, 71490.332678278791718 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 57254.930926057495526, 49935.259871731723251 ], [ 57254.930926057495526, 50739.932227414457884 ], [ 58059.603281740230159, 50739.932227414457884 ], [ 58059.603281740230159, 49935.259871731723251 ], [ 57254.930926057495526, 49935.259871731723251 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 79821.458168834345997, 141931.473488137096865 ], [ 79821.458168834345997, 142500.462767473713029 ], [ 80390.447448170962161, 142500.462767473713029 ], [ 80390.447448170962161, 141931.473488137096865 ], [ 79821.458168834345997, 141931.473488137096865 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 52124.034575800091261, 131381.510201416007476 ], [ 52124.034575800091261, 131950.49948075262364 ], [ 52693.023855136707425, 131950.49948075262364 ], [ 52693.023855136707425, 131381.510201416007476 ], [ 52124.034575800091261, 131381.510201416007476 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 44965.38002393989882, 158011.981899171398254 ], [ 44965.38002393989882, 159149.960457844630582 ], [ 46103.358582613131148, 159149.960457844630582 ], [ 46103.358582613131148, 158011.981899171398254 ], [ 44965.38002393989882, 158011.981899171398254 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 52397.243177949763776, 134549.920010089379502 ], [ 52397.243177949763776, 135354.592365772114135 ], [ 53201.915533632498409, 135354.592365772114135 ], [ 53201.915533632498409, 134549.920010089379502 ], [ 52397.243177949763776, 134549.920010089379502 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 70474.398434632414137, 182882.789480340026785 ], [ 70474.398434632414137, 184020.768039013259113 ], [ 71612.376993305646465, 184020.768039013259113 ], [ 71612.376993305646465, 182882.789480340026785 ], [ 70474.398434632414137, 182882.789480340026785 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 42726.185451369376096, 137355.745579739043023 ], [ 42726.185451369376096, 138493.724138412275352 ], [ 43864.164010042608425, 138493.724138412275352 ], [ 43864.164010042608425, 137355.745579739043023 ], [ 42726.185451369376096, 137355.745579739043023 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 72594.48426665221632, 162510.793739515036577 ], [ 72594.48426665221632, 163648.772298188268906 ], [ 73732.462825325448648, 163648.772298188268906 ], [ 73732.462825325448648, 162510.793739515036577 ], [ 72594.48426665221632, 162510.793739515036577 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 82314.142329063644866, 120971.264337211716338 ], [ 82314.142329063644866, 121775.936692894450971 ], [ 83118.814684746379498, 121775.936692894450971 ], [ 83118.814684746379498, 120971.264337211716338 ], [ 82314.142329063644866, 120971.264337211716338 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 53310.710468937541009, 154858.36280093336245 ], [ 53310.710468937541009, 155663.035156616097083 ], [ 54115.382824620275642, 155663.035156616097083 ], [ 54115.382824620275642, 154858.36280093336245 ], [ 53310.710468937541009, 154858.36280093336245 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 85107.001253455688129, 136175.204142359201796 ], [ 85107.001253455688129, 136744.19342169581796 ], [ 85675.990532792304293, 136744.19342169581796 ], [ 85675.990532792304293, 136175.204142359201796 ], [ 85107.001253455688129, 136175.204142359201796 ] ] ] } }
]
}'

# step 3

fields <- st_read(fields_string)

# step 4

fields_sim <- vector("list", length = dim(fields)[1])

for (i in 1:length(fields_sim)){

   fields_sim[[i]] <- simulate_soc(polygon=fields[i,])

}

# geostatistical simulation figure

focal_mean <- function(matrix_data, window_size = 5) {

   half_window <- floor(window_size / 2)
   smoothed_matrix <- matrix(NA, nrow = nrow(matrix_data), ncol = ncol(matrix_data))

   for (i in 1:nrow(matrix_data)){

      for (j in 1:ncol(matrix_data)){

         row_min <- max(1, i - half_window)
         row_max <- min(nrow(matrix_data), i + half_window)
         col_min <- max(1, j - half_window)
         col_max <- min(ncol(matrix_data), j + half_window)

         window <- matrix_data[row_min:row_max, col_min:col_max]
         smoothed_matrix[i, j] <- mean(window, na.rm = TRUE)

      }

   }

   return(smoothed_matrix)

}

pdf("geostatistical_simulation.pdf", width=12, height=12)
par(mfrow=c(1,1), mar=c(1,1,1,1))

the_matrix <- as.matrix(fields_sim[[1]]$soc_stock_hat)
dim(the_matrix) <- dim(fields_sim[[1]]$soc_stock_hat)[1:2]
image(the_matrix, col=viridis(100), axes=F)
smoothing_window <- matrix(1/25, nrow = 5, ncol = 5)
smoothed_matrix <- focal_mean(the_matrix)
quantiles <- quantile(round(smoothed_matrix), probs = seq(0, 1, by = 0.2), na.rm = TRUE)
contour(smoothed_matrix, add = TRUE, drawlabels = TRUE, col = rgb(1, 1, 1, 0.5), levels=quantiles)
polygon(x = c(0.05, 0.05+(200/(dim(the_matrix)[1]*10)), 0.05+(200/(dim(the_matrix)[1]*10)), 0.05),
        y = c(0.05, 0.05, 0.07, 0.07), border = "black", lwd = 2, col = NA)

dev.off()

# Major section IV

set.seed(1)

# step 1

n_fields <- 10
n_samples <- 1000

# step 2

sample_index <- sample(seq(1:dim(fields)[1]), n_fields, replace=F)
area <- sum(st_area(fields[sample_index,]))
points_per_field <- as.numeric(round(1.1*n_samples * (st_area(fields[sample_index,1]) / area)))

# step 3

sampled_points_list <- vector("list", length = n_fields)

# step 4

for (i in 1:n_fields){

   sampled_points_list[[i]] <-st_sample(fields[sample_index[i],], size = points_per_field[i], type = "random")

}

# step 5

results_list <- vector("list", length = n_fields)

for (i in 1:n_fields){

   error <- terra::extract(fields_sim[[sample_index[i]]]$soc_stock_error, terra::vect(sampled_points_list[[i]]))[,2]
   sigma <- terra::extract(fields_sim[[sample_index[i]]]$sigma, terra::vect(sampled_points_list[[i]]))[,2]

   # combine values and coordinates into a data frame

   coords <- st_coordinates(sampled_points_list[[i]])

   df <- data.frame(
     error = error,
     sigma = sigma,
     x = coords[, 1],
     y = coords[, 2]
   )

   results_list[[i]] <- na.omit(df)

}

# step 6

error_data <- do.call(rbind, results_list)
error_data <- error_data[sample(seq(1,dim(error_data)[1],1), n_samples, replace=F),]

# step 7

error_data$spe <- error_data$error/error_data$sigma

# step 8

variogram_model <- variogram(spe~1, data=error_data, locations = ~ x + y, cutoff=1000)
vgm_model_exp <- fit.variogram(variogram_model, vgm("Exp"))
vgm_model_sph <- fit.variogram(variogram_model, vgm("Sph"))
vgm_model_nugget <- fit.variogram(variogram_model, vgm("Nug"))

#step 9

sph_variogram <- function(h, psill, range, nugget){

   ifelse(h <= range,
                   nugget + psill * ((3 * h) / (2 * range) - (h^3) / (2 * range^3)),
                   nugget + psill)

}

exp_variogram <- function(h, psill, range, nugget){

   nugget + psill * (1 - exp(-h / range))

}

SSE_sph <- sum(sph_variogram(h=variogram_model$dist, psill=vgm_model_sph[2,2],
                             range=vgm_model_sph[2,3], nugget =vgm_model_sph[1,2]) - variogram_model$gamma)^2
SSE_exp <- sum(exp_variogram(h=variogram_model$dist, psill=vgm_model_exp[2,2],
                             range=vgm_model_exp[2,3], nugget =vgm_model_exp[1,2]) - variogram_model$gamma)^2
SSE_nugget <- sum(vgm_model_nugget[1,2] - variogram_model$gamma)^2

# geostatistical simulation figure

pdf("variogram.pdf", width=6, height=6)
plot(y=variogram_model$gamma, x=variogram_model$dist, pch=16, ylim=c(0,1.2), xlab="distance (meters)", ylab="semivariance")
h <- seq(0, 1000, length.out = 100)
gamma_values_exp <- exp_variogram(h, psill=vgm_model_exp[2,2], range=vgm_model_exp[2,3], nugget=vgm_model_exp[1,2])
gamma_values_sph <- sph_variogram(h, psill=vgm_model_sph[2,2], range=vgm_model_sph[2,3], nugget=vgm_model_sph[1,2])
lines(x=h, y=gamma_values_exp, col=viridis(3)[1], lwd=2)
lines(x=h, y=gamma_values_sph, col=viridis(3)[2], lwd=2)
abline(h=vgm_model_nugget[1,2], col=viridis(3)[3], lwd=2)
legend("topleft", legend=c("Exponential", "Spherical", "Nugget"),
       col=c(viridis(3)[1],viridis(3)[2],viridis(3)[3]), lwd=2, cex=1, bty="n")
dev.off()

# Major section 5

set.seed(1)

# step 1

fields_to_sample <- seq(1,dim(fields)[1])
sampled_fields <- lapply(fields_sim[fields_to_sample], function(x) x$sigma)
sampled_fields_df <- lapply(sampled_fields, as.data.frame, xy = TRUE)
sampled_fields_df <- do.call(rbind, sampled_fields_df)
names(sampled_fields_df)[3] <- "sigma"

# step 2

n_pairs <- 100000
sample_indices <- matrix(sample(1:dim(sampled_fields_df)[1], n_pairs * 2, replace = TRUE), ncol = 2)

# step 3

distances <- apply(sample_indices, 1, function(x){

  dist(rbind(sampled_fields_df[x[1],], sampled_fields_df[x[2],]))

})

# step 4

gamma <- sph_variogram(distances, psill=vgm_model_sph[2,2], range=vgm_model_sph[2,3], nugget=vgm_model_sph[1,2])

# step 5

rho <- (sum(vgm_model_sph[,2]) - gamma) / sum(vgm_model_sph[,2])

#step 6

vars <- sampled_fields_df$sigma[sample_indices[,1]] * sampled_fields_df$sigma[sample_indices[,2]] * rho
mean(vars)

# Major section 6

pdf("probability_of_exceedance.pdf", width=23/2.54, height=10/2.54)

mat <- matrix(c(1,1,1,2,3,4,5,5,5),3,3, byrow=T)
layout(mat, widths=lcm(c(7,7,7)), heights=lcm(c(1,5,2)))
par(mar=c(1,1,1,1), adj=0.5)
plot(seq(1,10), main="Probability of exceedance", col=NA, axes=F)
par(adj=0)

par(mar=c(1,2,1,1))
figure_4 <- rnorm(1000000, mean=0.2, sd=sqrt(0.0105))
plot(density(figure_4), main="", xlab = "", lwd=2, axes=F, xlim=c(-0.2,1.2), ylim=c(0,4))
axis(1)
axis(2)
abline(v=quantile(figure_4, c(0.333)), lty=2)
creditable_amount_1 <- quantile(figure_4, c(0.333))
deduction = 1 - quantile(figure_4, c(0.333))/0.2
text(x=0.4, y=3.5, "1 year")
text(x=0.4, y=3, paste(round(deduction*100,1),"% deduction", sep=""))

figure_4 <- rnorm(1000000, mean=0.4, sd=sqrt(0.0105))
plot(density(figure_4), main="",
xlab = "", lwd=2, axes=F, xlim=c(-0.2,1.2), ylim=c(0,4))
axis(1)
axis(2)
abline(v=quantile(figure_4, c(0.333)), lty=2)
creditable_amount_2 <- quantile(figure_4, c(0.333))
deduction = 1 - quantile(figure_4, c(0.333))/0.4
text(x=0.6, y=3.5, "2 years")
text(x=0.6, y=3, paste(round(deduction*100,1),"% deduction", sep=""))

figure_4 <- rnorm(1000000, mean=0.6, sd=sqrt(0.0105))
plot(density(figure_4), main="",
xlab = "", lwd=2, axes=F, xlim=c(-0.2,1.2), ylim=c(0,4))
axis(1)
axis(2)
abline(v=quantile(figure_4, c(0.333)), lty=2)
creditable_amount_3 <- quantile(figure_4, c(0.333))
deduction = 1 - quantile(figure_4, c(0.333))/0.6
text(x=0.0, y=3.5, "3 years")
text(x=0.0, y=3, paste(round(deduction*100,1),"% deduction", sep=""))

par(mar=c(0,0,5,0), adj=0.5)
plot(seq(1,10), main=expression(paste(bar(Delta), " ", "\u00B7", " ",  ""[t], " (t SOC / unit area)")), col=NA, axes=F)

dev.off()

# this code below here computes the variance for each individual field. It does not need to be included in the actual Appendix

set.seed(1)

field_vars <- matrix(NA, nrow=dim(fields)[1], ncol=1)

for (i in 1:dim(fields)[1]){

   plot(1, main=i)

   sampled_field <- lapply(fields_sim[i], function(x) x$sigma)
   sampled_field_df <- lapply(sampled_field, as.data.frame, xy = TRUE)
   sampled_field_df <- do.call(rbind, sampled_field_df)
   names(sampled_field_df)[3] <- "sigma"

   sample_indices <- matrix(sample(1:dim(sampled_field_df)[1], 10000 * 2, replace = TRUE), ncol = 2)

   distances <- apply(sample_indices, 1, function(x){

      dist(rbind(sampled_fields_df[x[1],], sampled_fields_df[x[2],]))

   })

   gamma <- sph_variogram(distances, psill=vgm_model_sph[2,2], range=vgm_model_sph[2,3], nugget=vgm_model_sph[1,2])

   rho <- (sum(vgm_model_sph[,2]) - gamma) / sum(vgm_model_sph[,2])

   vars <- sampled_field_df$sigma[sample_indices[,1]] * sampled_field_df$sigma[sample_indices[,2]] * rho
   mean(vars)

   field_vars[i,1] <- mean(vars)

}
```
</details>

The document contains six major sections:

- **I. Setting up the R environment**: This section installs the
  necessary R packages and loads them in the current R session.

- **II. Geostatistical simulation of SOC**: This section illustrates a
  custom function that generates SOC maps under a specified
  geostatistical model. This custom function is applied to all 100
  fields.

- **III. Visualization of geostatistical simulation output**: This
  section inputs coordinates for 100 simulated fields and illustrates
  the result of a geostatistical simulation for one 320 acre field.

- **IV. Fit a variogram to the standardized prediction error**: Here we
  show how to compute the standardized prediction error and fit three
  variogram models.

- **V. Variance of the project mean**: This section describes the
  methods originally developed by [Wadoux and Heuvelink
  (2023)](https://doi.org/10.1111/2041-210X.14106) to compute the
  variance of a spatial average.

- **VI. Variance of the mean stock change and computing the uncertainty
  deduction**: This section illustrates how to apply the methods
  developed in the tool to estimate the variance of the mean stock
  change and how to compute the uncertainty deduction as defined in
  [VM0042 version
  2.1](https://verra.org/methodologies/vm0042-improved-agricultural-land-management-v2-1/).

Major sections I - V begin with a code block that can be copied and
pasted into an R terminal. These code blocks are redundant subsets of
the “End-to-end code block” provided earlier. The use of `set.seed(1)`
at the start of each section’s code ensures reproducibility. After each
code block, a detailed explanation follows, outlining the steps involved
in the calculations, with references to specific equations in the main
text.

**I. Setting up the R environment**

<details>
  <summary>Show Code</summary>

``` r
set.seed(1)
install.packages(c("gstat", "sf", "terra", "viridis"))
library(gstat)
library(sf)
library(terra)
library(viridis)
```
</details>

Here we install and load the four R packages required by the analysis.

- `install.packages(c("gstat", "sf", "terra", "viridis"))` This command
  installs four R packages from CRAN (the Comprehensive R Archive
  Network).

- `gstat` provides geostatistical modeling, prediction, and
  interpolation functions.

- `sf` stands for “simple features,” a package for handling and
  analyzing spatial vector data, supporting standard formats like
  shapefiles and geojson.

- `terra` is used for handling spatial raster data (grids), a faster and
  more modern alternative to the raster package.

- `viridis` provides color scales (e.g., for maps) that are perceptually
  uniform, colorblind-friendly, and printer-friendly.

- `library(<package>)` loads the specific `<package>` into the current R
  session, making its functions available for use. Installation is
  necessary only once per system (or environment), but you need to
  install a package again if the package has been uninstalled, you are
  working in a different environment, or the package requires an update.

**II. Geostatistical simulation of SOC**

<details>
  <summary>Show Code</summary>

``` r
set.seed(1)
simulate_soc <- function(polygon, ground_sample_distance=10,
                         psill=0.1, range=200, nugget=0, beta=54, model='Sph', scale=4){

   # step 1

   polygon <- st_transform(polygon, 5070)

   # step 2

   field <- st_make_grid(polygon, cellsize = ground_sample_distance, what = "centers")
   field_coords <- st_coordinates(field)
   field <- as.data.frame(field_coords)
   names(field) <- c('x1', 'x2')

   # step 3

   soc_stock <- gstat(formula=z~1, locations=~x1+x2, dummy=TRUE, beta=beta,
                 model=vgm(psill=psill, range=range, nugget=nugget, model=model), nmax=40)
   soc_stock <- predict(soc_stock, newdata=field, nsim=1)

   # step 4

   combined_matrix <- cbind(field$x1, field$x2, soc_stock$sim1)
   soc_stock_points_df <- data.frame(x = combined_matrix[, 1], y = combined_matrix[, 2],
                                     soc_stock = combined_matrix[, 3])
   soc_stock_points <- vect(soc_stock_points_df, geom = c("x", "y"), crs = "EPSG:5070")
   raster_template <- rast(ext(soc_stock_points), res = ground_sample_distance, crs = "EPSG:5070")
   soc_stock <- rasterize(soc_stock_points, raster_template, field = "soc_stock")

   # step 5

   sigma <- gstat(formula=z~1, locations=~x1+x2, dummy=TRUE, beta=0,
        model=vgm(psill=1, range=range, nugget=0, model=model), nmax=40)
   sigma_pred <- predict(sigma, newdata=field, nsim=1)
   sigma <- qchisq(pnorm(sigma_pred$sim1), 2)
   sigma <- sqrt(sigma) * scale

   # step 6

   combined_matrix <- cbind(field$x1, field$x2, sigma)
   sigma_points_df <- data.frame(x = combined_matrix[, 1], y = combined_matrix[, 2],
                                 sigma = combined_matrix[, 3])
   sigma_points <- vect(sigma_points_df, geom = c("x", "y"), crs = "EPSG:5070")
   raster_template <- rast(ext(sigma_points), res = ground_sample_distance, crs = "EPSG:5070")
   sigma <- rasterize(sigma_points, raster_template, field = "sigma")

   # step 7

   error <- gstat(formula=z~1, locations=~x1+x2, dummy=TRUE, beta=0,
        model=vgm(psill=1, range=range, nugget=0, model=model), nmax=40)
   error_pred <- predict(error, newdata=field, nsim=1)
   error <- (error_pred$sim1 - mean(error_pred$sim1))/sd(error_pred$sim1)

   # step 8

   combined_matrix <- cbind(field$x1, field$x2, error)
   error_points_df <- data.frame(x = combined_matrix[, 1], y = combined_matrix[, 2],
                                 error = combined_matrix[, 3])
   error_points <- vect(error_points_df, geom = c("x", "y"), crs = "EPSG:5070")
   raster_template <- rast(ext(error_points), res = ground_sample_distance, crs = "EPSG:5070")
   error <- rasterize(error_points, raster_template, field = "error")

   # step 9

   soc_stock_error <- error*sigma
   soc_stock_hat <- soc_stock + soc_stock_error

   # step 10

   return(list(soc_stock=soc_stock, soc_stock_hat=soc_stock_hat,
               soc_stock_error=soc_stock_error, sigma=sigma))

}
```
</details>

The function `simulate_soc` generates simulated SOC stock under a known
geostatistical model, and combines them into a map of SOC stock over a
known depth range.

**Function arguments:**

- `polygon`: The spatial geometry in simple feature format within which
  the simulation will be performed (i.e. a polygon representing a field
  boundary).

- `ground_sample_distance`: The distance between sample points for
  creating a grid. For example, if `ground_sample_distance` is 10, as is
  the case here, the function will produce a grid where each pixel
  corresponds to a 10 by 10 meter square.

- `psill`, `range`, `nugget`, `beta`: Parameters for modeling the
  spatial variation of SOC stock (variogram parameters for the
  geostatistical model). These include:

  - `psill`: Partial sill (variance).

  - `range`: Spatial correlation range.

  - `nugget`: Random noise (the spatially uncorrelated portion of the
    variability).

  - `beta`: The mean of the value being simulated. Here is this 54 tC /
    hectare.

- `model`: The type of variogram model (e.g., spherical “Sph”,
  exponential, “Exp”, or nugget “Nug”).

**Steps in the function:**

**1.** Transform the Coordinate Reference System (CRS) using:

<details>
  <summary>Show Code</summary>

``` r
polygon <- st_transform(polygon, 5070)
```
</details>

The input polygon is transformed to EPSG:5070, an equal-area projected
coordinate system, to ensure consistent units (meters) for spatial
operations. Project proponents must select a coordinate system that is
appropriate for their project and report the EPSG code of codes in the
Model Validation Report.

**2.** Create a Grid of Sample Points using:

<details>
  <summary>Show Code</summary>

``` r
field <- st_make_grid(polygon, cellsize = ground_sample_distance, what = "centers")
field_coords <- st_coordinates(field)
field <- as.data.frame(field_coords)
names(field) <- c('x1', 'x2')
```
</details>

A regular grid of points is generated over the polygon using
`st_make_grid`. The grid spacing is determined by
`ground_sample_distance`. The grid centers are used as sampling
locations. The coordinates of each grid cell center are extracted using
`st_coordinates`, and converted into a data frame. The coordinates are
given the names `x1` and `x2`.

**3.** Simulate SOC stock under a model of spatial covariance:

<details>
  <summary>Show Code</summary>

``` r
soc_stock <- gstat(formula=z~1, locations=~x1+x2, dummy=TRUE, beta=beta,
              model=vgm(psill=psill, range=range, nugget=nugget, model=model), nmax=40)
soc_stock <- predict(soc_stock, newdata=field, nsim=1)
```
</details>

A spatial model for SOC stock is defined using the `gstat` package and
parameters `psill`, `range`, and `nugget`.The `predict` function is used
to simulate spatially correlated values.

**4.** Generate a raster of SOC stock values from the simulation:

<details>
  <summary>Show Code</summary>

``` r
combined_matrix <- cbind(field$x1, field$x2, soc_stock$sim1)
soc_stock_points_df <- data.frame(x = combined_matrix[, 1], y = combined_matrix[, 2],
                                  soc_stock = combined_matrix[, 3])
soc_stock_points <- vect(soc_stock_points_df, geom = c("x", "y"), crs = "EPSG:5070")
raster_template <- rast(ext(soc_stock_points), res = ground_sample_distance, crs = "EPSG:5070")
soc_stock <- rasterize(soc_stock_points, raster_template, field = "soc_stock")
```
</details>

The coordinates of grid cell centers are combined with simulated
`soc_stock` into a spatial vector object called `soc_stock_points`. The
points are then gridded onto `raster_template` to produce `soc_stock`,
which represents SOC (tC / hectare).

**5.** Simulate the predictive standard deviation under a model of
spatial covariance:

<details>
  <summary>Show Code</summary>

``` r
sigma <- gstat(formula=z~1, locations=~x1+x2, dummy=TRUE, beta=0,
    model=vgm(psill=1, range=range, nugget=0, model=model), nmax=40)
sigma_pred <- predict(sigma, newdata=field, nsim=1)
sigma <- qchisq(pnorm(sigma_pred$sim1), 2)
sigma <- sqrt(sigma) * scale
```
</details>

A similar geostatistical simulation is performed for the predictive
standard deviation. The output is transformed into a Chi-square
distribution with 2 degrees of freedom and scaled using the `scale`
parameter.

- `pnorm(sigma_pred$sim1)` converts the simulated values into
  probabilities (cumulative distribution function) using the standard
  normal distribution. This maps each value to a probability between 0
  and 1.

- `qchisq(..., 2)` converts these probabilities into quantiles of the
  Chi-square distribution with 2 degrees of freedom. This transformation
  results in values that follow a Chi-square distribution.

**6.** Create a raster of predictive standard deviation values:

<details>
  <summary>Show Code</summary>

``` r
combined_matrix <- cbind(field$x1, field$x2, sigma)
sigma_points_df <- data.frame(x = combined_matrix[, 1], y = combined_matrix[, 2],
                              sigma = combined_matrix[, 3])
sigma_points <- vect(sigma_points_df, geom = c("x", "y"), crs = "EPSG:5070")
raster_template <- rast(ext(sigma_points), res = ground_sample_distance, crs = "EPSG:5070")
sigma <- rasterize(sigma_points, raster_template, field = "sigma")
```
</details>

The simulated values are similarly converted into a raster, using
`vect`, `rast`, and `rasterize` functions. In practice, predictive
standard deviations can be computed using any valid method. They are
generated by simulation here for the purpose of illustration.

**7.** Simulate the standardized model prediction error under a model of
spatial covariance:

<details>
  <summary>Show Code</summary>

``` r
error <- gstat(formula=z~1, locations=~x1+x2, dummy=TRUE, beta=0,
    model=vgm(psill=1, range=range, nugget=0, model=model), nmax=40)
error_pred <- predict(error, newdata=field, nsim=1)
error <- (error_pred$sim1 - mean(error_pred$sim1))/sd(error_pred$sim1)
```
</details>

The standardized model prediction error is generated using a spatial
covariance model. These values will be scaled to units of SOC stock in
step 9.

**8.** Create a raster of the standardized prediction error

<details>
  <summary>Show Code</summary>

``` r
combined_matrix <- cbind(field$x1, field$x2, error)
error_points_df <- data.frame(x = combined_matrix[, 1], y = combined_matrix[, 2],
                             error = combined_matrix[, 3])
error_points <- vect(error_points_df, geom = c("x", "y"), crs = "EPSG:5070")
raster_template <- rast(ext(error_points), res = ground_sample_distance, crs = "EPSG:5070")
error <- rasterize(error_points, raster_template, field = "error")
```
</details>

The standardized prediction error is converted into a raster, using
`vect`, `rast`, and `rasterize` functions.

**9.** Calculate the SOC stock error and the predicted value of SOC
stock

<details>
  <summary>Show Code</summary>

``` r
soc_stock_error <- error*sigma
soc_stock_hat <- soc_stock + soc_stock_error
```
</details>

The `soc_stock_error` is the standardized `error` multiplied by the
predictive standard deviation (`sigma`). `soc_stock_hat` is the quantity
that would normally be predicted by a digital soil mapping model.

**10.** Return the results:

<details>
  <summary>Show Code</summary>

``` r
return(list(soc_stock=soc_stock, soc_stock_hat=soc_stock_hat,
           soc_stock_error=soc_stock_error, sigma=sigma))
```
</details>

The function returns a list that includes the true values of SOC stock,
represented as `soc_stock`, the predicted values of SOC stock denoted as
`soc_stock_hat`, the SOC stock error labeled as `soc_stock_error`, and
the predictive standard deviation represented by `sigma`. All of these
are provided as SpatRaster objects.

**III. Visualization of geostatistical simulation output**

We will apply the geostatistical simulation to 100 simulated fields and
visualize the output as a map. To do this we need to create a simple
features object that contains each field, and then apply the function to
each field individually.

<details>
  <summary>Show Code</summary>

``` r
set.seed(1)

# step 1

fields_string <- '{
"type": "FeatureCollection",
"name": "simulated_fields",
"crs": { "type": "name", "properties": { "name": "urn:ogc:def:crs:EPSG::5070" } },
"features": [
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 145157.901969870261382, 135341.593432327586925 ], [ 145157.901969870261382, 136479.571991000819253 ], [ 146295.88052854349371, 136479.571991000819253 ], [ 146295.88052854349371, 135341.593432327586925 ], [ 145157.901969870261382, 135341.593432327586925 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 143280.429234553274, 129700.909625173051609 ], [ 143280.429234553274, 130686.427965946058976 ], [ 144265.947575326281367, 130686.427965946058976 ], [ 144265.947575326281367, 129700.909625173051609 ], [ 143280.429234553274, 129700.909625173051609 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 136114.261258934770012, 142700.958537676313426 ], [ 136114.261258934770012, 143686.476878449320793 ], [ 137099.779599707777379, 143686.476878449320793 ], [ 137099.779599707777379, 142700.958537676313426 ], [ 136114.261258934770012, 142700.958537676313426 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 165308.245266636513406, 137339.885777786897961 ], [ 165308.245266636513406, 138477.864336460130289 ], [ 166446.223825309745735, 138477.864336460130289 ], [ 166446.223825309745735, 137339.885777786897961 ], [ 165308.245266636513406, 137339.885777786897961 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 122639.673937464278424, 128160.288199407310458 ], [ 122639.673937464278424, 129298.266758080542786 ], [ 123777.652496137510752, 129298.266758080542786 ], [ 123777.652496137510752, 128160.288199407310458 ], [ 122639.673937464278424, 128160.288199407310458 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 138974.744563743850449, 109786.563249276121496 ], [ 138974.744563743850449, 110772.081590049128863 ], [ 139960.262904516857816, 110772.081590049128863 ], [ 139960.262904516857816, 109786.563249276121496 ], [ 138974.744563743850449, 109786.563249276121496 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 160303.090820463432465, 123133.384369816878461 ], [ 160303.090820463432465, 123702.373649153494625 ], [ 160872.080099800019525, 123702.373649153494625 ], [ 160872.080099800019525, 123133.384369816878461 ], [ 160303.090820463432465, 123133.384369816878461 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 146049.925255510985153, 114757.434049850256997 ], [ 146049.925255510985153, 115562.10640553299163 ], [ 146854.597611193690682, 115562.10640553299163 ], [ 146854.597611193690682, 114757.434049850256997 ], [ 146049.925255510985153, 114757.434049850256997 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 144173.199657852732344, 94671.736420751229161 ], [ 144173.199657852732344, 95809.71497942446149 ], [ 145311.178216525964672, 95809.71497942446149 ], [ 145311.178216525964672, 94671.736420751229161 ], [ 144173.199657852732344, 94671.736420751229161 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 151374.378671368351206, 122664.884349430110888 ], [ 151374.378671368351206, 123650.402690203118254 ], [ 152359.897012141358573, 123650.402690203118254 ], [ 152359.897012141358573, 122664.884349430110888 ], [ 151374.378671368351206, 122664.884349430110888 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 125943.262877311150078, 125930.587300641971524 ], [ 125943.262877311150078, 126916.105641414978891 ], [ 126928.781218084157445, 126916.105641414978891 ], [ 126928.781218084157445, 125930.587300641971524 ], [ 125943.262877311150078, 125930.587300641971524 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 153130.545107728394214, 115159.737985610452597 ], [ 153130.545107728394214, 115964.41034129318723 ], [ 153935.217463411099743, 115964.41034129318723 ], [ 153935.217463411099743, 115159.737985610452597 ], [ 153130.545107728394214, 115159.737985610452597 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 152530.084722661820706, 146546.064735146152088 ], [ 152530.084722661820706, 147531.583075919159455 ], [ 153515.603063434828073, 147531.583075919159455 ], [ 153515.603063434828073, 146546.064735146152088 ], [ 152530.084722661820706, 146546.064735146152088 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 145905.121982681215741, 132762.82098411876359 ], [ 145905.121982681215741, 133567.493339801498223 ], [ 146709.79433836392127, 133567.493339801498223 ], [ 146709.79433836392127, 132762.82098411876359 ], [ 145905.121982681215741, 132762.82098411876359 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 112651.577805660956074, 122421.528239680061233 ], [ 112651.577805660956074, 123559.506798353293561 ], [ 113789.556364334188402, 123559.506798353293561 ], [ 113789.556364334188402, 122421.528239680061233 ], [ 112651.577805660956074, 122421.528239680061233 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 101369.272834764575236, 138570.954285429848824 ], [ 101369.272834764575236, 139375.626641112583457 ], [ 102173.945190447309869, 139375.626641112583457 ], [ 102173.945190447309869, 138570.954285429848824 ], [ 101369.272834764575236, 138570.954285429848824 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 115408.022759273779229, 151359.765026564273285 ], [ 115408.022759273779229, 152497.743585237505613 ], [ 116546.001317947011557, 152497.743585237505613 ], [ 116546.001317947011557, 151359.765026564273285 ], [ 115408.022759273779229, 151359.765026564273285 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 147961.892260234744754, 151526.177970361080952 ], [ 147961.892260234744754, 152330.850326043815585 ], [ 148766.564615917450283, 152330.850326043815585 ], [ 148766.564615917450283, 151526.177970361080952 ], [ 147961.892260234744754, 151526.177970361080952 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 130505.756363293243339, 153601.480326096876524 ], [ 130505.756363293243339, 154586.998666869883891 ], [ 131491.274704066250706, 154586.998666869883891 ], [ 131491.274704066250706, 153601.480326096876524 ], [ 130505.756363293243339, 153601.480326096876524 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 135630.5870061814785, 132578.617851524351863 ], [ 135630.5870061814785, 133383.290207207086496 ], [ 136435.259361864213133, 133383.290207207086496 ], [ 136435.259361864213133, 132578.617851524351863 ], [ 135630.5870061814785, 132578.617851524351863 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 72334.376593913824763, 25798.734105261602963 ], [ 72334.376593913824763, 26603.406460944333958 ], [ 73139.048949596559396, 26603.406460944333958 ], [ 73139.048949596559396, 25798.734105261602963 ], [ 72334.376593913824763, 25798.734105261602963 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 55496.932607235517935, 23994.285919064826885 ], [ 55496.932607235517935, 24563.275198401439411 ], [ 56065.921886572134099, 24563.275198401439411 ], [ 56065.921886572134099, 23994.285919064826885 ], [ 55496.932607235517935, 23994.285919064826885 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 58697.939336054994783, 19145.749188500325545 ], [ 58697.939336054994783, 19950.421544183060178 ], [ 59502.611691737729416, 19950.421544183060178 ], [ 59502.611691737729416, 19145.749188500325545 ], [ 58697.939336054994783, 19145.749188500325545 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 75704.292960263803252, 11636.488241425633532 ], [ 75704.292960263803252, 12774.466800098862223 ], [ 76842.27151893703558, 12774.466800098862223 ], [ 76842.27151893703558, 11636.488241425633532 ], [ 75704.292960263803252, 11636.488241425633532 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 66918.974593142032973, 42980.79477037252218 ], [ 66918.974593142032973, 43549.784049709138344 ], [ 67487.963872478649137, 43549.784049709138344 ], [ 67487.963872478649137, 42980.79477037252218 ], [ 66918.974593142032973, 42980.79477037252218 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 56685.876494248906965, 0.0 ], [ 56685.876494248906965, 804.672355682734633 ], [ 57490.548849931641598, 804.672355682734633 ], [ 57490.548849931641598, 0.0 ], [ 56685.876494248906965, 0.0 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 75692.009489521762589, 42305.751386167990859 ], [ 75692.009489521762589, 43291.269726941012777 ], [ 76677.527830294784508, 43291.269726941012777 ], [ 76677.527830294784508, 42305.751386167990859 ], [ 75692.009489521762589, 42305.751386167990859 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 49630.625905063578102, 8782.640547267079455 ], [ 49630.625905063578102, 9768.158888040097736 ], [ 50616.144245836600021, 9768.158888040097736 ], [ 50616.144245836600021, 8782.640547267079455 ], [ 49630.625905063578102, 8782.640547267079455 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 43478.568443753028987, 38460.82331394252833 ], [ 43478.568443753028987, 39446.341654715550249 ], [ 44464.08678452604363, 39446.341654715550249 ], [ 44464.08678452604363, 38460.82331394252833 ], [ 43478.568443753028987, 38460.82331394252833 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 61227.033085654264141, 5155.381889572036016 ], [ 61227.033085654264141, 5960.054245254770649 ], [ 62031.705441336998774, 5960.054245254770649 ], [ 62031.705441336998774, 5155.381889572036016 ], [ 61227.033085654264141, 5155.381889572036016 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 103037.727414619075716, 132270.954432818543864 ], [ 103037.727414619075716, 133408.932991491776193 ], [ 104175.705973292308045, 133408.932991491776193 ], [ 104175.705973292308045, 132270.954432818543864 ], [ 103037.727414619075716, 132270.954432818543864 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 83300.700715937768109, 164710.955192765512038 ], [ 83300.700715937768109, 165848.933751438744366 ], [ 84438.679274611000437, 165848.933751438744366 ], [ 84438.679274611000437, 164710.955192765512038 ], [ 83300.700715937768109, 164710.955192765512038 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 108364.484243563463679, 137623.993931042641634 ], [ 108364.484243563463679, 138192.983210379257798 ], [ 108933.473522900079843, 138192.983210379257798 ], [ 108933.473522900079843, 137623.993931042641634 ], [ 108364.484243563463679, 137623.993931042641634 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 83124.578136528391042, 137432.406574811320752 ], [ 83124.578136528391042, 138237.078930494055385 ], [ 83929.250492211125675, 138237.078930494055385 ], [ 83929.250492211125675, 137432.406574811320752 ], [ 83124.578136528391042, 137432.406574811320752 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 110102.326110944210086, 138786.790056168189039 ], [ 110102.326110944210086, 139772.308396941196406 ], [ 111087.844451717217453, 139772.308396941196406 ], [ 111087.844451717217453, 138786.790056168189039 ], [ 110102.326110944210086, 138786.790056168189039 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 99110.777529425176908, 126392.061629651259864 ], [ 99110.777529425176908, 127377.579970424267231 ], [ 100096.295870198184275, 127377.579970424267231 ], [ 100096.295870198184275, 126392.061629651259864 ], [ 99110.777529425176908, 126392.061629651259864 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 91021.006321180757368, 135420.9474931077566 ], [ 91021.006321180757368, 136406.465833880763967 ], [ 92006.524661953764735, 136406.465833880763967 ], [ 92006.524661953764735, 135420.9474931077566 ], [ 91021.006321180757368, 135420.9474931077566 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 86501.122839395698975, 137849.900093489937717 ], [ 86501.122839395698975, 138418.889372826553881 ], [ 87070.112118732315139, 138418.889372826553881 ], [ 87070.112118732315139, 137849.900093489937717 ], [ 86501.122839395698975, 137849.900093489937717 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 72874.773602248795214, 154122.805013602192048 ], [ 72874.773602248795214, 155108.323354375199415 ], [ 73860.291943021817133, 155108.323354375199415 ], [ 73860.291943021817133, 154122.805013602192048 ], [ 72874.773602248795214, 154122.805013602192048 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 92929.144773854626692, 157655.187275788950501 ], [ 92929.144773854626692, 158459.85963147165603 ], [ 93733.817129537361325, 158459.85963147165603 ], [ 93733.817129537361325, 157655.187275788950501 ], [ 92929.144773854626692, 157655.187275788950501 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 191561.082853839790914, 61712.230497823431506 ], [ 191561.082853839790914, 62516.902853506166139 ], [ 192365.755209522496443, 62516.902853506166139 ], [ 192365.755209522496443, 61712.230497823431506 ], [ 191561.082853839790914, 61712.230497823431506 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 129031.886759883258492, 50225.331500685264473 ], [ 129031.886759883258492, 50794.320780021880637 ], [ 129600.876039219874656, 50794.320780021880637 ], [ 129600.876039219874656, 50225.331500685264473 ], [ 129031.886759883258492, 50225.331500685264473 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 166929.07864343962865, 71866.166497358732158 ], [ 166929.07864343962865, 72435.155776695348322 ], [ 167498.06792277621571, 72435.155776695348322 ], [ 167498.06792277621571, 71866.166497358732158 ], [ 166929.07864343962865, 71866.166497358732158 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 155186.747134067030856, 64005.390923383689369 ], [ 155186.747134067030856, 64810.063279066424002 ], [ 155991.419489749736385, 64810.063279066424002 ], [ 155991.419489749736385, 64005.390923383689369 ], [ 155186.747134067030856, 64005.390923383689369 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 157535.602369393891422, 67288.982522465026705 ], [ 157535.602369393891422, 67857.971801801642869 ], [ 158104.591648730478482, 67857.971801801642869 ], [ 158104.591648730478482, 67288.982522465026705 ], [ 157535.602369393891422, 67288.982522465026705 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 162547.188538991496898, 55252.177572510569007 ], [ 162547.188538991496898, 55821.166851847185171 ], [ 163116.177818328083958, 55821.166851847185171 ], [ 163116.177818328083958, 55252.177572510569007 ], [ 162547.188538991496898, 55252.177572510569007 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 177555.130808853165945, 51675.045627295075974 ], [ 177555.130808853165945, 52813.024185968308302 ], [ 178693.109367526398273, 52813.024185968308302 ], [ 178693.109367526398273, 51675.045627295075974 ], [ 177555.130808853165945, 51675.045627295075974 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 174783.703782119526295, 46807.620095306934672 ], [ 174783.703782119526295, 47945.598653980167001 ], [ 175921.682340792758623, 47945.598653980167001 ], [ 175921.682340792758623, 46807.620095306934672 ], [ 174783.703782119526295, 46807.620095306934672 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 149411.29390274384059, 61666.769351347058546 ], [ 149411.29390274384059, 62652.287692120080465 ], [ 150396.812243516847957, 62652.287692120080465 ], [ 150396.812243516847957, 61666.769351347058546 ], [ 149411.29390274384059, 61666.769351347058546 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 160879.647807697969256, 30883.627532089587476 ], [ 160879.647807697969256, 31452.61681142620364 ], [ 161448.637087034556316, 31452.61681142620364 ], [ 161448.637087034556316, 30883.627532089587476 ], [ 160879.647807697969256, 30883.627532089587476 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 173751.123617220815504, 103758.860245651521836 ], [ 173751.123617220815504, 104563.532601334256469 ], [ 174555.795972903521033, 104563.532601334256469 ], [ 174555.795972903521033, 103758.860245651521836 ], [ 173751.123617220815504, 103758.860245651521836 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 186894.469247967615956, 96608.329439950248343 ], [ 186894.469247967615956, 97413.001795632982976 ], [ 187699.141603650321485, 97413.001795632982976 ], [ 187699.141603650321485, 96608.329439950248343 ], [ 186894.469247967615956, 96608.329439950248343 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 146909.931992284284206, 108331.621853278382332 ], [ 146909.931992284284206, 108900.611132614998496 ], [ 147478.921271620871266, 108900.611132614998496 ], [ 147478.921271620871266, 108331.621853278382332 ], [ 146909.931992284284206, 108331.621853278382332 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 137704.347153485083254, 116690.441643075275351 ], [ 137704.347153485083254, 117675.959983848282718 ], [ 138689.865494258090621, 117675.959983848282718 ], [ 138689.865494258090621, 116690.441643075275351 ], [ 137704.347153485083254, 116690.441643075275351 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 152273.413796942360932, 104739.019658227960463 ], [ 152273.413796942360932, 105308.008937564576627 ], [ 152842.403076278947992, 105308.008937564576627 ], [ 152842.403076278947992, 104739.019658227960463 ], [ 152273.413796942360932, 104739.019658227960463 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 146921.215120827720966, 97771.76352481234062 ], [ 146921.215120827720966, 98909.742083485572948 ], [ 148059.193679500953294, 98909.742083485572948 ], [ 148059.193679500953294, 97771.76352481234062 ], [ 146921.215120827720966, 97771.76352481234062 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 139064.927321239490993, 102729.723082216922194 ], [ 139064.927321239490993, 103534.395437899656827 ], [ 139869.599676922225626, 103534.395437899656827 ], [ 139869.599676922225626, 102729.723082216922194 ], [ 139064.927321239490993, 102729.723082216922194 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 189628.143729580711806, 65444.061898701300379 ], [ 189628.143729580711806, 66582.040457374532707 ], [ 190766.122288253944134, 66582.040457374532707 ], [ 190766.122288253944134, 65444.061898701300379 ], [ 189628.143729580711806, 65444.061898701300379 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 159688.426189050165704, 82061.095510575862136 ], [ 159688.426189050165704, 83199.074069249094464 ], [ 160826.404747723398032, 83199.074069249094464 ], [ 160826.404747723398032, 82061.095510575862136 ], [ 159688.426189050165704, 82061.095510575862136 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 155425.535415117745288, 77509.238563938808511 ], [ 155425.535415117745288, 78313.910919621543144 ], [ 156230.207770800450817, 78313.910919621543144 ], [ 156230.207770800450817, 77509.238563938808511 ], [ 155425.535415117745288, 77509.238563938808511 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 11065.490896847884869, 68073.241000041991356 ], [ 11065.490896847884869, 69211.219558715223684 ], [ 12203.469455521113559, 69211.219558715223684 ], [ 12203.469455521113559, 68073.241000041991356 ], [ 11065.490896847884869, 68073.241000041991356 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 45368.132940816729388, 67796.706845553184394 ], [ 45368.132940816729388, 68365.696124889800558 ], [ 45937.122220153345552, 68365.696124889800558 ], [ 45937.122220153345552, 67796.706845553184394 ], [ 45368.132940816729388, 67796.706845553184394 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 5173.25926182582225, 77305.565945607260801 ], [ 5173.25926182582225, 78110.238301289995434 ], [ 5977.931617508556883, 78110.238301289995434 ], [ 5977.931617508556883, 77305.565945607260801 ], [ 5173.25926182582225, 77305.565945607260801 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 52735.326532146667887, 93933.223466890238342 ], [ 52735.326532146667887, 94737.895822572972975 ], [ 53539.99888782940252, 94737.895822572972975 ], [ 53539.99888782940252, 93933.223466890238342 ], [ 52735.326532146667887, 93933.223466890238342 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 5189.143444343777446, 69374.780498642037855 ], [ 5189.143444343777446, 69943.76977797865402 ], [ 5758.13272368039361, 69943.76977797865402 ], [ 5758.13272368039361, 69374.780498642037855 ], [ 5189.143444343777446, 69374.780498642037855 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 18897.289617016245757, 74192.413664833380608 ], [ 18897.289617016245757, 74997.086020516115241 ], [ 19701.961972698980389, 74997.086020516115241 ], [ 19701.961972698980389, 74192.413664833380608 ], [ 18897.289617016245757, 74192.413664833380608 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 17545.653036780138791, 76021.179631100589177 ], [ 17545.653036780138791, 77159.158189773821505 ], [ 18683.631595453367481, 77159.158189773821505 ], [ 18683.631595453367481, 76021.179631100589177 ], [ 17545.653036780138791, 76021.179631100589177 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 31961.9073392897335, 101491.756107603228884 ], [ 31961.9073392897335, 102629.734666276461212 ], [ 33099.885897962965828, 102629.734666276461212 ], [ 33099.885897962965828, 101491.756107603228884 ], [ 31961.9073392897335, 101491.756107603228884 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 11429.487762641874724, 65919.764679910003906 ], [ 11429.487762641874724, 66488.75395924662007 ], [ 11998.47704197848725, 66488.75395924662007 ], [ 11998.47704197848725, 65919.764679910003906 ], [ 11429.487762641874724, 65919.764679910003906 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 41435.134829127491685, 67033.62039505658322 ], [ 41435.134829127491685, 68171.598953729815548 ], [ 42573.113387800724013, 68171.598953729815548 ], [ 42573.113387800724013, 67033.62039505658322 ], [ 41435.134829127491685, 67033.62039505658322 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 40849.280293897558295, 56663.686298754182644 ], [ 40849.280293897558295, 57232.675578090798808 ], [ 41418.269573234174459, 57232.675578090798808 ], [ 41418.269573234174459, 56663.686298754182644 ], [ 40849.280293897558295, 56663.686298754182644 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 11585.553013606167951, 45781.705983143867343 ], [ 11585.553013606167951, 46919.684541817099671 ], [ 12723.531572279396642, 46919.684541817099671 ], [ 12723.531572279396642, 45781.705983143867343 ], [ 11585.553013606167951, 45781.705983143867343 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 37001.596997050000937, 61027.545959364317241 ], [ 37001.596997050000937, 61596.535238700933405 ], [ 37570.586276386617101, 61596.535238700933405 ], [ 37570.586276386617101, 61027.545959364317241 ], [ 37001.596997050000937, 61027.545959364317241 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 0.0, 45834.396962507962598 ], [ 0.0, 46972.375521181194927 ], [ 1137.97855867322869, 46972.375521181194927 ], [ 1137.97855867322869, 45834.396962507962598 ], [ 0.0, 45834.396962507962598 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 41766.609906603269337, 55364.271951205097139 ], [ 41766.609906603269337, 56502.250509878329467 ], [ 42904.588465276501665, 56502.250509878329467 ], [ 42904.588465276501665, 55364.271951205097139 ], [ 41766.609906603269337, 55364.271951205097139 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 31451.802940959765692, 13927.568613745237599 ], [ 31451.802940959765692, 15065.547172418466289 ], [ 32589.78149963299802, 15065.547172418466289 ], [ 32589.78149963299802, 13927.568613745237599 ], [ 31451.802940959765692, 13927.568613745237599 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 19216.231326370194438, 35756.761329508051858 ], [ 19216.231326370194438, 36325.750608844668022 ], [ 19785.220605706810602, 36325.750608844668022 ], [ 19785.220605706810602, 35756.761329508051858 ], [ 19216.231326370194438, 35756.761329508051858 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 22259.665690789552173, 51819.968889388299431 ], [ 22259.665690789552173, 52957.947448061531759 ], [ 23397.644249462780863, 52957.947448061531759 ], [ 23397.644249462780863, 51819.968889388299431 ], [ 22259.665690789552173, 51819.968889388299431 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 28976.861486724534188, 64382.091964086081134 ], [ 28976.861486724534188, 64951.081243422697298 ], [ 29545.850766061150352, 64951.081243422697298 ], [ 29545.850766061150352, 64382.091964086081134 ], [ 28976.861486724534188, 64382.091964086081134 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 47724.165795299435558, 45699.21466350431001 ], [ 47724.165795299435558, 46837.193222177542339 ], [ 48862.144353972667886, 46837.193222177542339 ], [ 48862.144353972667886, 45699.21466350431001 ], [ 47724.165795299435558, 45699.21466350431001 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 70172.867416825640248, 69818.866980314283865 ], [ 70172.867416825640248, 70956.845538987516193 ], [ 71310.845975498872576, 70956.845538987516193 ], [ 71310.845975498872576, 69818.866980314283865 ], [ 70172.867416825640248, 69818.866980314283865 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 70850.625328338181134, 74517.32520902986289 ], [ 70850.625328338181134, 75321.997564712597523 ], [ 71655.297684020915767, 75321.997564712597523 ], [ 71655.297684020915767, 74517.32520902986289 ], [ 70850.625328338181134, 74517.32520902986289 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 72094.099046544113662, 70439.681612130996655 ], [ 72094.099046544113662, 71008.670891467612819 ], [ 72663.088325880729826, 71008.670891467612819 ], [ 72663.088325880729826, 70439.681612130996655 ], [ 72094.099046544113662, 70439.681612130996655 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 54668.142153146640339, 94306.365042221907061 ], [ 54668.142153146640339, 95291.883382994914427 ], [ 55653.660493919662258, 95291.883382994914427 ], [ 55653.660493919662258, 94306.365042221907061 ], [ 54668.142153146640339, 94306.365042221907061 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 44694.696510508969368, 84679.106935501346015 ], [ 44694.696510508969368, 85483.779291184080648 ], [ 45499.368866191704001, 85483.779291184080648 ], [ 45499.368866191704001, 84679.106935501346015 ], [ 44694.696510508969368, 84679.106935501346015 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 42341.026263565028785, 88292.805201349474373 ], [ 42341.026263565028785, 89278.323542122496292 ], [ 43326.544604338043428, 89278.323542122496292 ], [ 43326.544604338043428, 88292.805201349474373 ], [ 42341.026263565028785, 88292.805201349474373 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 40779.882433717226377, 89132.226852284744382 ], [ 40779.882433717226377, 90270.20541095797671 ], [ 41917.860992390458705, 90270.20541095797671 ], [ 41917.860992390458705, 89132.226852284744382 ], [ 40779.882433717226377, 89132.226852284744382 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 68756.593753907320206, 72311.554305654106429 ], [ 68756.593753907320206, 73297.072646427128348 ], [ 69742.112094680342125, 73297.072646427128348 ], [ 69742.112094680342125, 72311.554305654106429 ], [ 68756.593753907320206, 72311.554305654106429 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 83243.979235271443031, 71490.332678278791718 ], [ 83243.979235271443031, 72475.851019051813637 ], [ 84229.497576044450398, 72475.851019051813637 ], [ 84229.497576044450398, 71490.332678278791718 ], [ 83243.979235271443031, 71490.332678278791718 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 57254.930926057495526, 49935.259871731723251 ], [ 57254.930926057495526, 50739.932227414457884 ], [ 58059.603281740230159, 50739.932227414457884 ], [ 58059.603281740230159, 49935.259871731723251 ], [ 57254.930926057495526, 49935.259871731723251 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 79821.458168834345997, 141931.473488137096865 ], [ 79821.458168834345997, 142500.462767473713029 ], [ 80390.447448170962161, 142500.462767473713029 ], [ 80390.447448170962161, 141931.473488137096865 ], [ 79821.458168834345997, 141931.473488137096865 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 52124.034575800091261, 131381.510201416007476 ], [ 52124.034575800091261, 131950.49948075262364 ], [ 52693.023855136707425, 131950.49948075262364 ], [ 52693.023855136707425, 131381.510201416007476 ], [ 52124.034575800091261, 131381.510201416007476 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 44965.38002393989882, 158011.981899171398254 ], [ 44965.38002393989882, 159149.960457844630582 ], [ 46103.358582613131148, 159149.960457844630582 ], [ 46103.358582613131148, 158011.981899171398254 ], [ 44965.38002393989882, 158011.981899171398254 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 52397.243177949763776, 134549.920010089379502 ], [ 52397.243177949763776, 135354.592365772114135 ], [ 53201.915533632498409, 135354.592365772114135 ], [ 53201.915533632498409, 134549.920010089379502 ], [ 52397.243177949763776, 134549.920010089379502 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 70474.398434632414137, 182882.789480340026785 ], [ 70474.398434632414137, 184020.768039013259113 ], [ 71612.376993305646465, 184020.768039013259113 ], [ 71612.376993305646465, 182882.789480340026785 ], [ 70474.398434632414137, 182882.789480340026785 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 42726.185451369376096, 137355.745579739043023 ], [ 42726.185451369376096, 138493.724138412275352 ], [ 43864.164010042608425, 138493.724138412275352 ], [ 43864.164010042608425, 137355.745579739043023 ], [ 42726.185451369376096, 137355.745579739043023 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 72594.48426665221632, 162510.793739515036577 ], [ 72594.48426665221632, 163648.772298188268906 ], [ 73732.462825325448648, 163648.772298188268906 ], [ 73732.462825325448648, 162510.793739515036577 ], [ 72594.48426665221632, 162510.793739515036577 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 82314.142329063644866, 120971.264337211716338 ], [ 82314.142329063644866, 121775.936692894450971 ], [ 83118.814684746379498, 121775.936692894450971 ], [ 83118.814684746379498, 120971.264337211716338 ], [ 82314.142329063644866, 120971.264337211716338 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 53310.710468937541009, 154858.36280093336245 ], [ 53310.710468937541009, 155663.035156616097083 ], [ 54115.382824620275642, 155663.035156616097083 ], [ 54115.382824620275642, 154858.36280093336245 ], [ 53310.710468937541009, 154858.36280093336245 ] ] ] } },
{ "type": "Feature", "properties": { }, "geometry": { "type": "Polygon", "coordinates": [ [ [ 85107.001253455688129, 136175.204142359201796 ], [ 85107.001253455688129, 136744.19342169581796 ], [ 85675.990532792304293, 136744.19342169581796 ], [ 85675.990532792304293, 136175.204142359201796 ], [ 85107.001253455688129, 136175.204142359201796 ] ] ] } }
]
}'

# step 3

fields <- st_read(fields_string)

# step 4

fields_sim <- vector("list", length = dim(fields)[1])

for (i in 1:length(fields_sim)){

   fields_sim[[i]] <- simulate_soc(polygon=fields[i,])

}
```

</details>

**Steps in the code:**

**1.** Input a text string with field boundaries:

<details>
  <summary>Show Code</summary>

``` r
fields_string <- '{
"type": "FeatureCollection",
"features": [
...
]
}'
```

</details>


The text string is in `geojson` format. All fields here are 80, 160, 240
or 320 acres. There are 100 spatially clustered fields in this object.

**2.** Convert the string into an simple features object:

<details>
  <summary>Show Code</summary>

``` r
fields <- st_read(fields_string)
```
</details>

**3.** Initialize a list for storing results:

<details>
  <summary>Show Code</summary>

``` r
fields_sim <- vector("list", length = dim(fields)[1])
```
</details>

**4.** Apply the simulation function to each field:

<details>
  <summary>Show Code</summary>

``` r
for (i in 1:length(fields_sim)){

   fields_sim[[i]] <- simulate_soc(polygon=fields[i,])

}
```
</details>

For each iteration, the `simulate_soc` function is called with the i-th
field as input. The result of `simulate_soc` is assigned to the i-th
position in the `fields_sim` list. Every element of the list contains
four objects.

- `soc_stock` is a SpatRaster object that contains true values of SOC
  stock in units of tC / hectare

- `soc_stock_hat` is a SpatRaster object that contains predicted values
  of SOC stock in units of tC / hectare (analogous to predictions from a
  digital soil mapping model)

- `soc_stock_error` a SpatRaster object that contains `soc_stock_hat` -
  `soc_stock`

- `sigma` is a SpatRaster object that contains the predictive standard
  deviation

The plot below shows the geostatistical simulation for one field of 320
acres. Every pixel in `soc_stock_hat` represents a predicted value of
SOC stock to a depth of 30 cm at for a single 10 by 10 meter square:

$`\widehat{\text{SOC}}_{i,t}`$ (Eq. 1 in the main text).

[Geostatistical simulation](geostatistical_simulation.pdf)

<div style="text-align: center;">

<object data="geostatistical_simulation.pdf"
          type="application/pdf" width="800" height="800">
<p>
Your browser does not support PDFs. Please download the PDF to view it:
<a href="geostatistical_simulation.pdf">Download PDF</a>.
</p>
</object>
<figcaption style="text-align: left; margin-top: 10px;">
<strong>Figure 1: Example geostatistical simulation.</strong> SOC stock
for a single 320-acre field. The scale bar in the lower left is 200
meters. Colors correspond to the values of SOC stock in each field,
where warmer colors correspond to larger values. Contour intervals are
plotted on each field with labels in units of tons/hectare to a depth of
30 cm.
</figcaption>

</div>

<br>

**IV. Fit a variogram to the standardized prediction error**

<details>
  <summary>Show Code</summary>

``` r
set.seed(1)

# step 1

n_fields <- 10
n_samples <- 1000

# step 2

sample_index <- sample(seq(1:dim(fields)[1]), n_fields, replace=F)
area <- sum(st_area(fields[sample_index,]))
points_per_field <- as.numeric(round(1.1*n_samples * (st_area(fields[sample_index,1]) / area)))

# step 3

sampled_points_list <- vector("list", length = n_fields)

# step 4

for (i in 1:n_fields){

   sampled_points_list[[i]] <-st_sample(fields[sample_index[i],], size = points_per_field[i], type = "random")

}

# step 5

results_list <- vector("list", length = n_fields)

for (i in 1:n_fields){

   error <- terra::extract(fields_sim[[sample_index[i]]]$soc_stock_error, terra::vect(sampled_points_list[[i]]))[,2]
   sigma <- terra::extract(fields_sim[[sample_index[i]]]$sigma, terra::vect(sampled_points_list[[i]]))[,2]

   coords <- st_coordinates(sampled_points_list[[i]])

   df <- data.frame(
     error = error,
     sigma = sigma,
     x = coords[, 1],
     y = coords[, 2]
   )

   results_list[[i]] <- na.omit(df)

}

# step 6

error_data <- do.call(rbind, results_list)
error_data <- error_data[sample(seq(1,dim(error_data)[1],1), n_samples, replace=F),]

# step 7

error_data$spe <- error_data$error/error_data$sigma

# step 8

variogram_model <- variogram(spe~1, data=error_data, locations = ~ x + y, cutoff=1000)
vgm_model_exp <- fit.variogram(variogram_model, vgm("Exp"))
vgm_model_sph <- fit.variogram(variogram_model, vgm("Sph"))
vgm_model_nugget <- fit.variogram(variogram_model, vgm("Nug"))

#step 9

sph_variogram <- function(h, psill, range, nugget){

   ifelse(h <= range,
                   nugget + psill * ((3 * h) / (2 * range) - (h^3) / (2 * range^3)),
                   nugget + psill)

}

exp_variogram <- function(h, psill, range, nugget){

   nugget + psill * (1 - exp(-h / range))

}

SSE_sph <- sum(sph_variogram(h=variogram_model$dist, psill=vgm_model_sph[2,2],
                             range=vgm_model_sph[2,3], nugget =vgm_model_sph[1,2]) - variogram_model$gamma)^2
SSE_exp <- sum(exp_variogram(h=variogram_model$dist, psill=vgm_model_exp[2,2],
                             range=vgm_model_exp[2,3], nugget =vgm_model_exp[1,2]) - variogram_model$gamma)^2
SSE_nugget <- sum(vgm_model_nugget[1,2] - variogram_model$gamma)^2
```
</details>

**Steps in the code:**

**1.** Define the number of fields to be sampled and the total number of
samples to be collected:

<details>
  <summary>Show Code</summary>

``` r
n_fields <- 10
n_samples <- 1000
```
</details>
The number of fields to be sampled is given by `n_fields`, and the total
number of samples to be collected is `n_samples`. These values can be
modified. The numbers selected here indicate that out of the 100 fields
in this hypothetical project, 10 will be randomly selected for sampling.

**2.** Randomly sample `n_fields` fields and allocate sampling effort

<details>
  <summary>Show Code</summary>

``` r
sample_index <- sample(seq(1:dim(fields)[1]), n_fields, replace=F)
area <- sum(st_area(fields[sample_index,]))
points_per_field <- as.numeric(round(1.1*n_samples * (st_area(fields[sample_index,1]) / area)))
```
</details>

`sample_index` is a vector of length `n_fields` that indexes fields at
random for sampling. `area` is the summed area of the `n_fields` fields.
`points_per_field` is the number of points to be randomly sampled within
each field. This number is proportional to the area of each field. For
example, if there were three fields to be sampled whose areas were 100,
200 and 300 acres, and the total number of samples to be collected is
1,000, then the function would allocate 200, 400 and 600 samples to
these fields, respectively, since they represent 20%, 40% and 60% of the
summed area. Note that the sample number is increased by 10% to account
for the possibility that some samples will happen to land on an edge
that is inside the field boundary but not within a pixel. See step 4
below for an illustration of how these cases are handled to ensure that
exactly `n_samples` are used.

**3.** Initialize a list for storing results:

<details>
  <summary>Show Code</summary>

``` r
sampled_points_list <- vector("list", length = n_fields)
```
</details>

The list`sampled_points_list` is initialized as an empty list of length
`n_fields`

**4.** Generate the sample locations within each field

<details>
  <summary>Show Code</summary>

``` r
for (i in 1:n_fields){

   sampled_points_list[[i]] <-st_sample(fields[sample_index[i],], size = points_per_field[i], type = "random")

}
```
</details>
This step iterates over every sampled field and randomly selects a
number of points within each field. The number of points to be selected
is given by `points_per_field`, computed in step 2, above.

**5.** Extract values at each sample location

<details>
  <summary>Show Code</summary>

``` r
results_list <- vector("list", length = n_fields)

for (i in 1:n_fields){

   error <- terra::extract(fields_sim[[sample_index[i]]]$soc_stock_error, terra::vect(sampled_points_list[[i]]))[,2]
   sigma <- terra::extract(fields_sim[[sample_index[i]]]$sigma, terra::vect(sampled_points_list[[i]]))[,2]

   coords <- st_coordinates(sampled_points_list[[i]])

   df <- data.frame(
     error = residual,
     sigma = sigma,
     x = coords[, 1],
     y = coords[, 2]
   )

   results_list[[i]] <- na.omit(df)

}
```
</details>

This loop iterates over each sampled field and extracts the values from
`soc_stock_error` and `sigma` at the random locations identified in step
3. The extraction is performed using these lines:

<details>
  <summary>Show Code</summary>

``` r
error <- terra::extract(fields_sim[[sample_index[i]]]$soc_stock_error, terra::vect(sampled_points_list[[i]]))[,2]
sigma <- terra::extract(fields_sim[[sample_index[i]]]$sigma, terra::vect(sampled_points_list[[i]]))[,2]
```
</details>

The extracted values are combined with coordinate locations into a data
frame. The data frame has four columns `error`,`sigma` `x`, and `y`.
Finally, the data frame is inserted into `results_list` at the i-th
position after removing any values where any value is NA. NA values can
occur when a point happens to fall on an edge that is inside the field
boundary but not within a pixel.

**6.** Combine the results across fields into a single data frame:

<details>
  <summary>Show Code</summary>

``` r
error_data <- do.call(rbind, results_list)
error_data <- error_data[sample(seq(1,dim(error_data)[1],1), n_samples, replace=F),]
```
</details>

The `do.call` function applies the function `rbind` to `results_list`.
The result, `error_data` is a data frame with columns `error`,`sigma`
`x`, and `y`. The second line randomly samples `n_samples` rows from the
resulting data frame. Random sampling from `error_data` is necessary
because step 2, above, increased the sample size by 10% to account for
the possibility of NA values. NA values can occur when a point happens
to fall inside the field boundary but not within a pixel.

**7.** Compute the standardized prediction error:

<details>
  <summary>Show Code</summary>

``` r
error_data$spe <- error_data$error/error_data$sigma
```
</details>

The standardized prediction error is derived by dividing the prediction
error at each sampled location by the predictive standard deviation.
Originally, the `simulate_soc` function produces the standardized
prediction error as a standardized variable and then multiplies it by
`sigma`, which expresses this error in units of SOC stock. Thus, in the
simulation, we could have worked directly with the simulated
standardized prediction error. However, we include this step here to
emphasize that, in real-world applications, prediction errors will need
to be divided by the predictive standard deviation.

**8.** Fit variograms to the standardized prediction error:

<details>
  <summary>Show Code</summary>

``` r
variogram_model <- variogram(spe~1, data=error_data, locations = ~ x + y, cutoff=1000)
vgm_model_exp <- fit.variogram(variogram_model, vgm("Exp"))
vgm_model_sph <- fit.variogram(variogram_model, vgm("Sph"))
vgm_model_nugget <- fit.variogram(variogram_model, vgm("Nug"))
```
</details>

This step computes the empirical variogram and fits exponential,
spherical, and nugget only models. The empirical variogram is plotted
below with lines showing the three models. These are the types of plots
described in Section 5.3 of the tool that must be included in the Model
Validation Report. In this case, visual examination makes clear that the
spherical variogram provides a better fit than the alternatives.
However, this can be demonstrated using model-selection criteria.

**9.** Compute the error sum of squares for each variogram model
`sph_variogram` is a custom function to compute the semivariance under a
spherical variogram model. This function, and an alternative for the
exponential variogram model, named `exp_variogram`, are shown below,
followed by the error sum of squares for each variogram model.

**Function arguments:**

- `h`: The distances at which semivariace calculations are required.

- `psill`, `range`, `nugget`: Variogam model parameters, extracted from
  the variogram model object (`vgm_model_sph`).

These calculations demonstrate that the error sum of squares for the
spherical, exponential and nugget-only models are 0.023, 0.307, and
15.161, which matches the visual interpretation in the figure below. If
the error sum of squares were used as a model selection criterion, the
project proponent must report these values in the Model Validation
Report, as stated in Section 5.3 of the tool.

<div style="text-align: center;">

<object data="variogram.pdf"
          type="application/pdf" width="800" height="800">
<p>
Your browser does not support PDFs. Please download the PDF to view it:
<a href="variogram.pdf">Download PDF</a>.
</p>
</object>
<figcaption style="text-align: left; margin-top: 10px;">
<strong>Figure 2: Example variograms.</strong> Three variogram models
fitted to the standardized prediction error. In this case, the
simulation is based on a spherical model, and consequently the spherical
model provides a better fit than two alternatives. Project proponents
must include a figure like this one in the Model Validation Report.
</figcaption>

</div>

<br> **V. Variance of the project mean**

<details>
  <summary>Show Code</summary>

``` r
set.seed(1)

# step 1

fields_to_sample <- seq(1,dim(fields)[1])
sampled_fields <- lapply(fields_sim[fields_to_sample], function(x) x$sigma)
sampled_fields_df <- lapply(sampled_fields, as.data.frame, xy = TRUE)
sampled_fields_df <- do.call(rbind, sampled_fields_df)
names(sampled_fields_df)[3] <- "sigma"

# step 2

n_pairs <- 100000
sample_indices <- matrix(sample(1:dim(sampled_fields_df)[1], n_pairs * 2, replace = TRUE), ncol = 2)

# step 3

distances <- apply(sample_indices, 1, function(x){

  dist(rbind(sampled_fields_df[x[1],], sampled_fields_df[x[2],]))

})

# step 4

gamma <- sph_variogram(distances, psill=vgm_model_sph[2,2], range=vgm_model_sph[2,3], nugget=vgm_model_sph[1,2])

# step 5

rho <- (sum(vgm_model_sph[,2]) - gamma) / sum(vgm_model_sph[,2])

#step 6

vars <- sampled_fields_df$sigma[sample_indices[,1]] * sampled_fields_df$sigma[sample_indices[,2]] * rho
mean(vars)
```
</details>

The variance of the project mean is calculated using the methods of
[Wadoux and Heuvelink (2023)](https://doi.org/10.1111/2041-210X.14106),
as described in Section 5.3 of the tool.

**Steps in the code:**

**1.** Select the fields to be sampled and convert them into data frame
format:

<details>
  <summary>Show Code</summary>

``` r
fields_to_sample <- seq(1,dim(fields)[1])
sampled_fields <- lapply(fields_sim[fields_to_sample], function(x) x$sigma)
sampled_fields_df <- lapply(sampled_fields, as.data.frame, xy = TRUE)
sampled_fields_df <- do.call(rbind, sampled_fields_df)
names(sampled_fields_df)[3] <- "sigma"
```
</details>

This step removes the `sigma` SpatRaster from every element of
`fields_sim` and organizes the data into a single data frame. Here every
field is sampled, but this could be changed by drawing a subset of
`fields_sim`. For example, `fields_sim[c(1,10,20)]` would sample fields
at positions 1, 10 and 20 in the `fields_sim` list.

- `lapply(..., function(x) x$sigma)` extracts the sigma SpatRaster
  object from each item in the list.

- `lapply(sampled_fields, as.data.frame, xy = TRUE)` converts each
  SpatRaster element into a data frame. The xy = TRUE argument includes
  the coordinates in the resulting data frame.

- `do.call(rbind, sampled_fields_df)` combines the list into a single
  data frame by row-binding them together.

**2.** Generate random sample pairs:

<details>
  <summary>Show Code</summary>


``` r
n_pairs <- 100000
sample_indices <- matrix(sample(1:dim(sampled_fields_df)[1], n_pairs * 2, replace = TRUE), ncol = 2)
```
</details>

The second line samples `n_pairs` of locations by randomly drawing row
numbers within `sampled_fields_df`. `sample_indices` contains two
columns, each of which represents a row in `sampled_fields_df` that
defines one point in the point pair.

**3.** Compute pairwise distances:

<details>
  <summary>Show Code</summary>

``` r
distances <- apply(sample_indices, 1, function(x){

  dist(rbind(sampled_fields_df[x[1],], sampled_fields_df[x[2],]))

})
```
</details>

- `apply(sample_indices, 1, ...)` iterates over each row (pair of
  indices) in `sample_indices`.

- `rbind(sampled_fields_df[x[1],], sampled_fields_df[x[2],])` selects
  the coordinates of the two points specified by the indices in the
  current row.

- `dist(...)` calculates the Euclidean distance between the two
  locations using their coordinates.

**4.** Compute the semivariance for each point pair using the spherical
variogram:

<details>
  <summary>Show Code</summary>

``` r
gamma <- sph_variogram(distances, psill=vgm_model_sph[2,2], range=vgm_model_sph[2,3], nugget=vgm_model_sph[1,2])
```
</details>

`sph_variogram` and `exp_variogram` are custom functions, defined above,
to compute the semivariance under a spherical or exponential variogram
model. `gamma` is the predicted semivariance for each pair of locations
using the spherical variogram model.

**5.** Calculate the correlation function of the standardized prediction
error:

<details>
  <summary>Show Code</summary>

``` r
rho <- (sum(vgm_model_sph[,2]) - gamma) / sum(vgm_model_sph[,2])
```
</details>

The variable `rho` is the correlation function, described in step 4 of
section 4 of [Wadoux and Heuvelink
(2023)](https://doi.org/10.1111/2041-210X.14106) and in Eq. 9 of the
main text of the tool.

**7.** Compute the variance of spatial average:

<details>
  <summary>Show Code</summary>

``` r
vars <- sampled_fields_df$sigma[sample_indices[,1]] * sampled_fields_df$sigma[sample_indices[,2]] * rho
mean(vars)
```
</details>

- `sampled_fields_df$sigma[sample_indices[,1]]` selects the predictive
  standard deviation value corresponding to the first point in each
  sample pair.

- `sampled_fields_df$sigma[sample_indices[,2]]` selects the predictive
  standard deviation value corresponding to the second point in each
  sample pair.

- `rho` multiplies these predictive standard deviation values by the
  spatial correlation function. `rho` is described in step 6 above, in
  part 4 of section 4 of [Wadoux and Heuvelink
  (2023)](https://doi.org/10.1111/2041-210X.14106) and in Eq. 9 in the
  main text of the tool.

- The resulting quantity represents the variance of the mean SOC stock,
  which is 0.006 at the project level. This value is smaller at the
  project level in comparison to any individual field. For instance, the
  variance of the mean for the field visualized in Figure 1 is 0.513,
  while the variance across all 100 fields ranges from 0.291 to 2.443.
  The variance diminishes at the project level because most locations
  are farther apart than the variogram range, resulting in an effective
  correlation of nearly zero.

**VI. Variance of the mean stock change and computing the uncertainty
deduction**

As described in the main text of the tool, the variance of the mean
stock change is:
$`\textit{var}\left(\overline{\widehat{\textit{SOC}}}_{t,\Delta t} - \overline{\widehat{\textit{SOC}}}_{t}\right) = \textit{var}\left(\overline{\widehat{\textit{SOC}}}_{t,\Delta t}\right) + \textit{var}\left(\overline{\widehat{\textit{SOC}}}_{t}\right) - 2 \rho \cdot \sqrt{{var}\left(\overline{\widehat{\textit{SOC}}}_{t,\Delta t}\right)} \cdot \sqrt{{var}\left(\overline{\widehat{\textit{SOC}}}_{t}\right)}`$
(Eq. 5 in the main text)

Here we illustrate how to use estimates of the variance of the mean to
compute the uncertainty deduction under [VM0042 version
2.1](https://verra.org/methodologies/vm0042-improved-agricultural-land-management-v2-1/).
The variance computed in section V corresponds to the term:

$`\textit{var}\left(\overline{\widehat{\textit{SOC}}}_{t}\right)`$ = 0.006
(in Eq. 5 of the main text)

Assume that this procedure is repeated at a second point in time three
years later, and the estimate is one third larger:

$`\textit{var}\left(\overline{\widehat{\textit{SOC}}}_{t,\Delta t}\right)`$
= 0.008 (in Eq. 5 of the main text)

The covariance term in Eq. 5 of the main text may be conservatively
ignored or estimated using a pseudo cross variogram. Assume this term
has been estimated and is:

$`2\rho \cdot \sqrt{\textit{var}\left(\overline{\widehat{\text{SOC}}_{t+\Delta t}}\right)} \cdot \sqrt{\textit{var}\left(\overline{\widehat{\text{SOC}}_t}\right)}`$
= 0.0035 (which assumes that `rho` in Eq. 5 = 0.5)

Using Eq. 5 in the main text, the variance of the mean stock change is
$0.006 + 0.008 - 0.0035 = 0.0105$. Note that the covariance term is
subtracted. This term can be conservatively ignored because it is very
unlikely to be negative and therefore ignoring it very unlikely to
increase the estimate of the variance of the mean stock change, which
will increase the uncertainty deduction.

To illustrate how the uncertainty deduction would be calculated, we will
assume that the project is monitored for three years and experiences a
moderate annual sequestration rate equal to 0.2 t of SOC / hectare /
year. The rate over three years is simply three times the annual rate,
or $0.2 \times 3 = 0.6$. Thus, in the absence of any uncertainty, the
potentially creditable amount of sequestration is the nominal value of
0.6, or an increase from 54 to 54.6 t of SOC / hectare, given that this
simulation assumed a starting value of 54 t of SOC / hectare. However,
uncertainty will reduce this number.

The figure below shows the probability distribution of the mean SOC
change, and is similar to Figure 4 on page 85 of [VM0042 version
2.1](https://verra.org/methodologies/vm0042-improved-agricultural-land-management-v2-1/).
Using the standard deviation of the mean stock change
(i.e. $`\sqrt{0.0105} = 0.103`$), the probability of exceedance method
results in a creditable amount of of 0.556 t of SOC / hectare, or a 7.3%
deduction relative to the nominal value. If we decrease the monitoring
period to 2 years or 1, resulting in a nominal sequestration rate of 0.4
or 0.2 t of SOC / hectare / year, respectively, the probability of
exceedance method indicates creditable amounts of 0.355 and 0.156 t of
SOC / hectare, or deductions of 11.1% and 22.3% relative to the nominal
value in each case.

<div style="text-align: center;">

<figure>
<object data="probability_of_exceedance.pdf" type="application/pdf" width="800" height="350">
<p>
Your browser does not support PDFs. Please download the PDF to view it:
<a href="probability_of_exceedance.pdf">Download PDF</a>.
</p>
</object>
<figcaption style="text-align: left; margin-top: 10px;">
<strong>Figure 3: Probability of exceedance.</strong> The value for
$\bar{\Delta} \cdot t$ used in the calculation of VCUs issued is
determined by applying an uncertainty deduction based on the 33.3rd
percentile of the estimated probability distribution of
$\bar{\Delta} \cdot t$. This variance of the probability distribution is
estimated using the methods described in this document.
</figcaption>
</figure>

</div>
